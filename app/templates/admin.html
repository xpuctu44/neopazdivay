<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Админ" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/styles.css') }}" />
    <style>
      .tabs{display:flex;gap:12px;margin:16px 0}
      .tab{padding:8px 12px;border-radius:8px;background:#1a2238;color:#e8eef5}
      .tab.active{background:#6ea8fe;color:#04142b}
      .panel{background:#151b2d;border:1px solid #223;padding:16px;border-radius:10px}
    </style>
  </head>
  <body>
    <header>
      <h1>Администрирование</h1>
    </header>
    <main>
      <nav class="tabs">
        <a class="tab {{ 'active' if active_tab=='schedule' else '' }}" href="/admin/schedule">График</a>
        <a class="tab {{ 'active' if active_tab=='planning' else '' }}" href="/admin/planning">Планирование</a>
        <a class="tab {{ 'active' if active_tab=='reports' else '' }}" href="/admin/reports">Отчеты</a>
        <a class="tab {{ 'active' if active_tab=='reports_shifts' else '' }}" href="/admin/reports/shifts">Смены</a>
        <a class="tab {{ 'active' if active_tab=='users' else '' }}" href="/admin/users">Сотрудники</a>
        <a class="tab {{ 'active' if active_tab=='stores' else '' }}" href="/admin/stores">Магазины</a>
      </nav>

      <section class="panel">
        {% if active_tab in ['schedule','planning'] %}
          <h2>{{ 'График' if active_tab=='schedule' else 'Планирование' }}</h2>
          {% if year and month %}
            <p style="color:#98a2b3">{{ year }}-{{ '%02d'|format(month) }}</p>
          {% endif %}
          <div style="overflow:auto">
            <form method="get" action="{{ '/admin/schedule' if readonly else '/admin/planning' }}" style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
              <input type="hidden" name="year" value="{{ year }}" />
              <input type="hidden" name="month" value="{{ month }}" />
              <label>Магазин
                <select name="store_id" style="min-width:200px">
                  <option value="">Все</option>
                  {% for s in stores or [] %}
                    <option value="{{ s.id }}" {{ 'selected' if store_id==s.id else '' }}>{{ s.name }}</option>
                  {% endfor %}
                </select>
              </label>
              <button type="submit">Применить</button>
            </form>
            <form method="post" action="{{ '/admin/planning/save' if not readonly else '#' }}">
              <input type="hidden" name="year" value="{{ year }}" />
              <input type="hidden" name="month" value="{{ month }}" />
              <table>
                <thead>
                  <tr>
                    <th>Сотрудник</th>
                    {% for d in days %}
                      <th>{{ d }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for emp in employees %}
                  <tr>
                    <td style="white-space:nowrap">{{ emp.full_name or emp.email }}</td>
                    {% for d in days %}
                    {% set key = (emp.id, d) %}
                    {% set current = entry_map.get(key) %}
                    <td>
                      {% if readonly %}
                        <span style="color:#e8eef5">{{ shift_labels.get(current, '') }}</span>
                      {% else %}
                        <select name="shift_{{ emp.id }}_{{ d }}">
                          <option value=""></option>
                          {% for code,label in shift_labels.items() %}
                            <option value="{{ code }}" {{ 'selected' if current==code else '' }}>{{ label }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                    </td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% if not readonly %}
                <div style="margin-top:12px;display:flex;gap:8px">
                  <button type="submit">Сохранить</button>
                </div>
              {% endif %}
            </form>
            {% if not readonly %}
              <form method="post" action="/admin/planning/publish" style="margin-top:8px">
                <input type="hidden" name="year" value="{{ year }}" />
                <input type="hidden" name="month" value="{{ month }}" />
                <button type="submit" class="btn">Сохранить и опубликовать</button>
              </form>
            {% endif %}
          </div>
        {% elif active_tab=='reports' %}
          <h2>Отчеты</h2>
          <form method="get" action="/admin/reports" style="margin:8px 0;display:flex;gap:8px;align-items:center">
            <label>Год <input type="number" min="2000" max="2100" name="year" value="{{ year or '' }}" style="width:110px"></label>
            <label>Месяц <input type="number" min="1" max="12" name="month" value="{{ month or '' }}" style="width:80px"></label>
            <button type="submit">Показать</button>
          </form>
          {% if report_rows is defined %}
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Сотрудник</th>
                  <th>Рабочие часы</th>
                  <th>Отгулы</th>
                  <th>Больничные</th>
                  <th>Отпуска</th>
                </tr>
              </thead>
              <tbody>
                {% for row in report_rows %}
                  <tr>
                    <td style="white-space:nowrap">{{ row.emp.full_name or row.emp.email }}</td>
                    <td>{{ row.hours }}</td>
                    <td>{{ row.off }}</td>
                    <td>{{ row.sick }}</td>
                    <td>{{ row.vacation }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p style="color:#98a2b3">Выберите год и месяц для отчета.</p>
          {% endif %}
        {% elif active_tab=='users' %}
          <h2>Сотрудники</h2>
          <form method="get" action="/admin/users" style="margin:8px 0;display:flex;gap:8px;align-items:center">
            <label>Магазин
              <select name="store_id" style="min-width:200px">
                <option value="">Все</option>
                {% for s in stores or [] %}
                  <option value="{{ s.id }}" {{ 'selected' if selected_store_id==s.id else '' }}>{{ s.name }}</option>
                {% endfor %}
              </select>
            </label>
            <button type="submit">Фильтровать</button>
          </form>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Сотрудник</th>
                  <th>Магазин</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for emp in employees or [] %}
                <tr>
                  <td style="white-space:nowrap">{{ emp.full_name or emp.email }}</td>
                  <td>{{ emp.store.name if emp.store else '' }}</td>
                  <td>
                    <form method="post" action="/admin/users/assign_store">
                      <input type="hidden" name="user_id" value="{{ emp.id }}" />
                      <input type="hidden" name="back" value="{{ request.url.path }}?store_id={{ selected_store_id or '' }}" />
                      <select name="store_id" style="min-width:200px">
                        <option value="">Не назначен</option>
                        {% for s in stores or [] %}
                          <option value="{{ s.id }}" {{ 'selected' if emp.store and emp.store.id==s.id else '' }}>{{ s.name }}</option>
                        {% endfor %}
                      </select>
                      <button type="submit">Назначить</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {% if active_tab=='reports_shifts' %}
          <h2>Отчет по сменам</h2>
          <form method="get" action="/admin/reports/shifts" style="margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label>Сотрудник
              <select name="user_id" style="min-width:220px">
                <option value="">— выберите —</option>
                {% for emp in employees or [] %}
                  <option value="{{ emp.id }}" {{ 'selected' if selected_user and selected_user.id==emp.id else '' }}>{{ emp.full_name or emp.email }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Год <input type="number" min="2000" max="2100" name="year" value="{{ year or '' }}" style="width:110px"></label>
            <label>Месяц <input type="number" min="1" max="12" name="month" value="{{ month or '' }}" style="width:80px"></label>
            <button type="submit">Показать</button>
          </form>
          {% if selected_user %}
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Начало</th>
                  <th>Окончание</th>
                  <th>Часы</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for e in entries %}
                <tr>
                  <td>{{ e.work_date }}</td>
                  <td>
                    <form method="post" action="/admin/reports/shifts/update">
                      <input type="hidden" name="attendance_id" value="{{ e.id }}" />
                      <input type="hidden" name="back" value="/admin/reports/shifts?user_id={{ selected_user.id }}&year={{ year }}&month={{ month }}" />
                      <input type="datetime-local" name="started_at" value="{{ (e.started_at.isoformat()[:16]) if e.started_at else '' }}" />
                  </td>
                  <td>
                      <input type="datetime-local" name="ended_at" value="{{ (e.ended_at.isoformat()[:16]) if e.ended_at else '' }}" />
                  </td>
                  <td>{{ '%.2f'|format(e.hours or 0) }}</td>
                  <td>
                      <button type="submit">Сохранить</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
        {% endif %}

        {% if active_tab=='stores' %}
          <h2>Магазины</h2>
          <form method="post" action="/admin/stores/add" style="display:grid;grid-template-columns:1fr;gap:8px;max-width:520px;margin:8px 0 16px 0">
            <label>Название магазина
              <input type="text" name="name" required />
            </label>
            <label>Адрес
              <input type="text" name="address" />
            </label>
            <div><button type="submit">Добавить магазин</button></div>
          </form>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Адрес</th>
                  <th>Активен</th>
                </tr>
              </thead>
              <tbody>
                {% for s in stores or [] %}
                <tr>
                  <td>{{ s.name }}</td>
                  <td>{{ s.address or '' }}</td>
                  <td>{{ 'Да' if s.is_active else 'Нет' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </section>

      <form method="post" action="/logout" style="margin-top:16px;">
        <button type="submit" class="btn" style="background:#eee">Выйти</button>
      </form>
    </main>
  </body>
  </html>

