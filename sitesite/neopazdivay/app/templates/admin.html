<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Админ панель" }}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .nav a {
        padding: 10px 15px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
      .nav a:hover {
        background: #0056b3;
      }
      .nav a.active {
        background: #28a745;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #007bff;
        text-decoration: none;
      }
      .back-link:hover {
        text-decoration: underline;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #007bff;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        color: #666;
        margin-top: 5px;
      }
      .form-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box;
      }
      .form-group select {
        background: white;
        cursor: pointer;
        appearance: auto;
        -webkit-appearance: auto;
        -moz-appearance: auto;
      }
      .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
      }

      /* Month selector specific styles */
      .month-selector select {
        min-width: 120px;
        margin: 0 5px;
      }

      .month-selector .btn {
        margin-left: 10px;
      }
      .form-group textarea {
        height: 80px;
        resize: vertical;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 1em;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background: #0056b3;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-success:hover {
        background: #218838;
      }
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      .btn-warning:hover {
        background: #e0a800;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .table th, .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .table th {
        background: #f8f9fa;
        font-weight: bold;
      }
      .table tr:hover {
        background: #f5f5f5;
      }
      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .schedule-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }
      .schedule-date {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }
      .schedule-item {
        background: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .schedule-item:last-child {
        margin-bottom: 0;
      }
      .employee-name {
        font-weight: bold;
        color: #007bff;
      }
      .time-range {
        color: #666;
        font-size: 0.9em;
      }
      .notes {
        color: #666;
        font-style: italic;
        margin-top: 5px;
      }
      .scheduling-container {
        overflow-x: auto;
        margin-top: 15px;
        max-width: 100%;
      }
      .scheduling-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75em;
        line-height: 1.2;
      }
      .scheduling-table th, .scheduling-table td {
        border: 1px solid #ddd;
        padding: 3px 4px;
        text-align: center;
        vertical-align: middle;
      }
      .scheduling-table th {
        background: #f8f9fa;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.7em;
        padding: 4px 2px;
      }
      .employee-column {
        min-width: 120px;
        max-width: 140px;
        text-align: left;
        position: sticky;
        left: 0;
        background: #f8f9fa;
        z-index: 20;
        font-size: 0.7em;
        padding: 4px 6px;
      }
      .date-column {
        min-width: 45px;
        max-width: 50px;
        font-size: 0.65em;
        padding: 2px;
      }
      .shift-cell {
        width: 35px;
        height: 28px;
        padding: 1px !important;
        text-align: center;
        border: 1px solid #ddd;
        cursor: pointer;
        position: relative;
        user-select: none;
        font-size: 0.65em;
      }
      .shift-cell:hover {
        border-color: #007bff;
      }
      .shift-cell.selected {
        background: #007bff !important;
        color: white;
        border-color: #0056b3;
      }
      .shift-cell.dragging {
        border-color: #2196f3;
      }
      .shift-cell.painting {
        box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        border-color: #2196f3;
      }
      .shift-cell.painted {
        animation: paintFlash 0.3s ease-out;
      }
      @keyframes paintFlash {
        0% { background-color: rgba(33, 150, 243, 0.3); }
        100% { background-color: inherit; }
      }

      /* Color coding for different shift types */
      .shift-cell[data-shift-type="work"] {
        background: #d4edda;
        border-color: #28a745;
      }
      .shift-cell[data-shift-type="work"]:hover {
        background: #c3e6cb;
        border-color: #1e7e34;
      }

      .shift-cell[data-shift-type="weekend"] {
        background: #fff3cd;
        border-color: #ffc107;
      }
      .shift-cell[data-shift-type="weekend"]:hover {
        background: #ffeaa7;
        border-color: #d39e00;
      }

      .shift-cell[data-shift-type="off"] {
        background: #f8d7da;
        border-color: #dc3545;
      }
      .shift-cell[data-shift-type="off"]:hover {
        background: #f5c6cb;
        border-color: #bd2130;
      }

      .shift-cell[data-shift-type="vacation"] {
        background: #d1ecf1;
        border-color: #17a2b8;
      }
      .shift-cell[data-shift-type="vacation"]:hover {
        background: #bee5eb;
        border-color: #117a8b;
      }

      .shift-cell[data-shift-type="sick"] {
        background: #e2e3e5;
        border-color: #6c757d;
      }
      .shift-cell[data-shift-type="sick"]:hover {
        background: #d6d8db;
        border-color: #545b62;
      }

      /* Draft/Published indicators */
      .shift-cell.draft {
        position: relative;
      }
      .shift-cell.published {
        position: relative;
      }
      .shift-cell.published::after {
        content: "✓";
        position: absolute;
        top: -2px;
        right: -2px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        font-size: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 1px solid white;
      }
      .draft-indicator {
        position: absolute;
        top: -2px;
        right: -2px;
        font-size: 10px;
        opacity: 0.8;
      }
      .shift-content {
        position: relative;
        z-index: 1;
      }

      /* Override selected state for colored cells */
      .shift-cell.selected[data-shift-type] {
        background: #007bff !important;
        color: white;
        border-color: #0056b3;
      }
      .shift-content {
        font-size: 0.6em;
        font-weight: bold;
        line-height: 1.1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #333;
        padding: 1px 0;
      }
      .shift-type {
        display: block;
        margin-bottom: 0px;
      }
      .shift-time {
        display: block;
        font-size: 0.5em;
        opacity: 0.8;
        line-height: 1;
      }

      /* Text colors for better contrast on colored backgrounds */
      .shift-cell[data-shift-type="work"] .shift-content,
      .shift-cell[data-shift-type="weekend"] .shift-content,
      .shift-cell[data-shift-type="off"] .shift-content,
      .shift-cell[data-shift-type="vacation"] .shift-content,
      .shift-cell[data-shift-type="sick"] .shift-content {
        color: #333;
      }

      /* Special text color for weekend (yellow background) */
      .shift-cell[data-shift-type="weekend"] .shift-content {
        color: #856404;
      }
      .shift-dropdown-container {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        min-width: 90px;
        max-width: 120px;
      }
      .shift-cell:hover .shift-dropdown-container {
        display: block;
      }
      .shift-dropdown {
        width: 100%;
        padding: 3px 5px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.65em;
        text-align: left;
        line-height: 1.2;
      }
      .shift-dropdown:hover {
        background: #f8f9fa;
      }
      .shift-dropdown:focus {
        outline: none;
        background: #e3f2fd;
      }
      .shift-info {
        display: none;
      }
      .selection-overlay {
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 123, 255, 0.1);
        border: 2px solid #007bff;
        pointer-events: none;
        z-index: 999;
      }

      /* Legend styling */
      .shift-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        font-size: 0.75em;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8em;
        font-weight: 500;
      }
      .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 2px;
      }
      .legend-item span {
        color: #495057;
      }

      /* Custom date picker styles */
      .custom-date-picker {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
      }
      .custom-date-picker.hidden {
        display: none;
      }
      .custom-date-picker.visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/dashboard" class="back-link">← Вернуться в dashboard</a>
      
      <h1>⚙️ Админ панель</h1>
      
      <div class="nav">
        <a href="/admin" class="{{ 'active' if active_tab == 'dashboard' else '' }}">Главная</a>
        <a href="/admin/employees" class="{{ 'active' if active_tab == 'employees' else '' }}">Сотрудники</a>
        <a href="/admin/scheduling-table" class="{{ 'active' if active_tab == 'scheduling_table' else '' }}">Таблица планирования</a>
        <a href="/admin/schedule" class="{{ 'active' if active_tab == 'schedule' else '' }}">График</a>
        <a href="/admin/attendance" class="{{ 'active' if active_tab == 'attendance' else '' }}">Редактирование присутствия</a>
        <a href="/admin/reports" class="{{ 'active' if active_tab == 'reports' else '' }}">Отчеты</a>
        <a href="/admin/stores" class="{{ 'active' if active_tab == 'stores' else '' }}">Магазины</a>
        <a href="/admin/allowed-ips" class="{{ 'active' if active_tab == 'allowed_ips' else '' }}">Разрешенные IP</a>
      </div>

      <div class="content">
        <!-- Уведомления об успешных операциях -->
        {% if request.query_params.get('success') == 'store_assigned' %}
        <div class="alert alert-success">
          ✅ Магазин успешно назначен сотруднику!
        </div>
        {% elif request.query_params.get('success') == 'status_changed' %}
        <div class="alert alert-success">
          ✅ Статус сотрудника успешно изменен!
        </div>
        {% elif request.query_params.get('error') == 'employee_not_found' %}
        <div class="alert alert-danger">
          ❌ Сотрудник не найден!
        </div>
        {% elif request.query_params.get('error') == 'server_error' %}
        <div class="alert alert-danger">
          ❌ Произошла ошибка сервера!
        </div>
        {% endif %}

        {% if active_tab == 'dashboard' %}
          <h3>📊 Общая статистика</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          
          {% if stats %}
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_users }}</div>
              <div class="stat-label">Всего пользователей</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_employees }}</div>
              <div class="stat-label">Сотрудников</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_admins }}</div>
              <div class="stat-label">Администраторов</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_stores }}</div>
              <div class="stat-label">Магазинов</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.today_schedules }}</div>
              <div class="stat-label">Смен сегодня</div>
            </div>
          </div>
          {% endif %}

        {% elif active_tab == 'employees' %}
          <h3>👥 Управление сотрудниками</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          
          {% if employees %}
          <div class="form-section">
            <h4>Список всех сотрудников</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Имя</th>
                  <th>Email</th>
                  <th>Роль</th>
                  <th>Дата рождения</th>
                  <th>Магазин</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for employee in employees %}
                <tr>
                  <td>{{ employee.full_name or 'Не указано' }}</td>
                  <td>{{ employee.email }}</td>
                  <td>
                    <span class="btn {{ 'btn-warning' if employee.role == 'admin' else 'btn-info' }}" style="padding: 5px 10px; font-size: 0.8em;">
                      {{ 'Администратор' if employee.role == 'admin' else 'Сотрудник' }}
                    </span>
                  </td>
                  <td>{{ employee.date_of_birth.strftime('%d.%m.%Y') if employee.date_of_birth else 'Не указано' }}</td>
                  <td>
                    {% if employee.store %}
                      <span class="btn btn-success" style="padding: 5px 10px; font-size: 0.8em;">
                        {{ employee.store.name }}
                      </span>
                    {% else %}
                      <span class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">
                        Не назначен
                      </span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="btn {{ 'btn-success' if employee.is_active else 'btn-danger' }}" style="padding: 5px 10px; font-size: 0.8em;">
                      {{ 'Активен' if employee.is_active else 'Неактивен' }}
                    </span>
                  </td>
                  <td>
                    <!-- Форма назначения магазина -->
                     <form method="post" action="/admin/employees/assign-store" style="display: inline-block; margin-right: 5px;" id="store-form-{{ employee.id }}">
                       <input type="hidden" name="employee_id" value="{{ employee.id }}">
                       <select name="store_id" onchange="submitStoreAssignment(this, '{{ employee.full_name or employee.email }}')" style="padding: 4px 6px; font-size: 0.85em; border: 1px solid #007bff; border-radius: 3px; background: white; cursor: pointer; min-width: 120px;">
                         <option value="">🏪 Снять назначение</option>
                         {% for store in stores %}
                         <option value="{{ store.id }}" {{ 'selected' if employee.store and employee.store.id == store.id else '' }}>
                           🏪 {{ store.name }}
                         </option>
                         {% endfor %}
                       </select>
                     </form>
                    
                    <!-- Кнопка изменения статуса -->
                    <form method="post" action="/admin/employees/toggle-status" style="display: inline-block;">
                      <input type="hidden" name="employee_id" value="{{ employee.id }}">
                      <button type="submit" class="btn {{ 'btn-danger' if employee.is_active else 'btn-success' }}" style="padding: 5px 10px; font-size: 0.8em;">
                        {{ 'Деактивировать' if employee.is_active else 'Активировать' }}
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>Нет зарегистрированных сотрудников.</p>
          {% endif %}


        {% elif active_tab == 'scheduling_table' %}
          <h3>📋 Таблица планирования</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <div class="form-section">
            <h4>Месячный график смен</h4>

            <!-- Month/Year Selector -->
            <div class="month-selector" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
              <form method="get" action="/admin/scheduling-table" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: bold; color: #333;">Выберите месяц и год:</label>
                <select name="month" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                  {% for month_option in months %}
                  <option value="{{ month_option.value }}" {{ 'selected' if month_option.value == selected_month else '' }}>
                    {{ month_option.name }}
                  </option>
                  {% endfor %}
                </select>
                <select name="year" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                  {% for year_option in years %}
                  <option value="{{ year_option.value }}" {{ 'selected' if year_option.value == selected_year else '' }}>
                    {{ year_option.name }}
                  </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">Показать</button>
              </form>
              <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                📅 <strong>Текущий выбор:</strong> {{ months[selected_month-1].name if selected_month else 'Текущий месяц' }} {{ selected_year if selected_year else 'текущий год' }}
              </div>
            </div>

            <p>Нажмите на ячейку, чтобы выбрать тип смены для сотрудника</p>

            <!-- Status indicator -->
            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
              <div style="display: flex; gap: 20px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #6c757d;">📝</span>
                  <span>Черновики: <strong id="draft-count">0</strong></span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #28a745;">✓</span>
                  <span>Опубликовано: <strong id="published-count">0</strong></span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #007bff;">📊</span>
                  <span>Всего: <strong id="total-count">0</strong></span>
                </div>
              </div>
            </div>

            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
              <p>💡 <strong>Быстрые действия:</strong></p>
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Двойной клик на клетке = выходной день</li>
                <li>Зажать и тянуть курсор = копирование типа смены на другие клетки</li>
                <li>Shift + зажать и тянуть = множественный выбор для массовых операций</li>
              </ul>
            </div>

            <!-- Legend for shift types -->
            <div class="shift-legend">
              <div class="legend-item">
                <div class="legend-color" style="background: #d4edda; border: 1px solid #28a745;"></div>
                <span>Рабочий день</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #fff3cd; border: 1px solid #ffc107;"></div>
                <span>Выходной</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #f8d7da; border: 1px solid #dc3545;"></div>
                <span>Отгул</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #d1ecf1; border: 1px solid #17a2b8;"></div>
                <span>Отпуск</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #e2e3e5; border: 1px solid #6c757d;"></div>
                <span>Больничный</span>
              </div>
            </div>

            {% if employees and month_dates %}
            <div class="scheduling-container">
              <table class="scheduling-table">
                <thead>
                  <tr>
                    <th class="employee-column">Сотрудник</th>
                    {% for work_date in month_dates %}
                    <th class="date-column">{{ work_date.strftime('%d.%m') }}<br><small>
                      {% if work_date.strftime('%a') == 'Mon' %}Пн
                      {% elif work_date.strftime('%a') == 'Tue' %}Вт
                      {% elif work_date.strftime('%a') == 'Wed' %}Ср
                      {% elif work_date.strftime('%a') == 'Thu' %}Чт
                      {% elif work_date.strftime('%a') == 'Fri' %}Пт
                      {% elif work_date.strftime('%a') == 'Sat' %}Сб
                      {% elif work_date.strftime('%a') == 'Sun' %}Вс
                      {% endif %}
                    </small></th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for employee in employees %}
                  <tr>
                    <td class="employee-name">
                      {{ employee.full_name or employee.email }}
                      <br><small style="color: #666;">({{ "Админ" if employee.role == "admin" else "Сотрудник" }})</small>
                    </td>
                    {% for work_date in month_dates %}
                    {% set cell_key = employee.id ~ '_' ~ work_date %}
                    {% set existing_shift = schedule_dict[cell_key] %}
                    <td class="shift-cell {{ 'published' if existing_shift and existing_shift.published else 'draft' }}"
                        data-employee-id="{{ employee.id }}"
                        data-date="{{ work_date }}"
                        data-shift-type="{{ existing_shift.shift_type if existing_shift else '' }}"
                        onclick="handleCellClick(this)"
                        onmousedown="startSelection(this)"
                        onmouseover="extendSelection(this)">
                      <div class="shift-content">
                        {% if existing_shift %}
                        <span class="shift-type">
                          {% if existing_shift.shift_type == 'work' %}Р{% elif existing_shift.shift_type == 'off' %}О{% elif existing_shift.shift_type == 'weekend' %}В{% elif existing_shift.shift_type == 'vacation' %}Отп{% elif existing_shift.shift_type == 'sick' %}Б{% endif %}
                        </span>
                        {% if existing_shift.start_time %}
                        <span class="shift-time">{{ existing_shift.start_time.strftime('%H:%M') }}</span>
                        {% endif %}
                        {% if not existing_shift.published %}
                        <span class="draft-indicator" title="Черновик - не опубликовано">📝</span>
                        {% endif %}
                        {% else %}
                        <span class="shift-type">-</span>
                        {% endif %}
                      </div>
                      <div class="shift-dropdown-container">
                        {% for shift_type in shift_types %}
                        <button class="shift-dropdown"
                                data-value="{{ shift_type.value }}"
                                onclick="selectShiftType(event, this, '{{ employee.id }}', '{{ work_date }}')">
                          {{ shift_type.label }}
                        </button>
                        {% endfor %}
                        <button class="shift-dropdown"
                                data-value=""
                                onclick="selectShiftType(event, this, '{{ employee.id }}', '{{ work_date }}')">
                          Очистить
                        </button>
                      </div>
                    </td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label for="default_store">Магазин по умолчанию:</label>
              <select id="default_store">
                <option value="">Без привязки к магазину</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Publish Button -->
            <div class="form-group" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0; color: #155724;">📢 Публикация расписания</h4>
              <p style="margin: 0 0 15px 0; color: #155724; font-size: 0.9em;">
                После внесения всех изменений нажмите кнопку "Опубликовать", чтобы сделать расписание видимым для сотрудников.
              </p>
              <button type="button" class="btn btn-success" onclick="publishSchedule()" style="font-size: 1em; padding: 10px 20px;">
                🚀 Опубликовать расписание
              </button>
              <div id="publish-status" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>
            {% else %}
            <p>Нет данных для отображения таблицы планирования.</p>
            {% endif %}
          </div>

        {% elif active_tab == 'schedule' %}
          <h3>📋 Просмотр графика</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <!-- Month/Year Selector for Schedule View -->
          <div class="month-selector" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            <form method="get" action="/admin/schedule" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <label style="font-weight: bold; color: #333;">Выберите месяц и год:</label>
              <select name="month" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                {% for month_option in months %}
                <option value="{{ month_option.value }}" {{ 'selected' if month_option.value == selected_month else '' }}>
                  {{ month_option.name }}
                </option>
                {% endfor %}
              </select>
              <select name="year" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                {% for year_option in years %}
                <option value="{{ year_option.value }}" {{ 'selected' if year_option.value == selected_year else '' }}>
                  {{ year_option.name }}
                </option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">Показать</button>
            </form>
            <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
              📅 <strong>Текущий выбор:</strong> {{ months[selected_month-1].name if selected_month else 'Текущий месяц' }} {{ selected_year if selected_year else 'текущий год' }}
            </div>
          </div>

          <!-- Info about published schedules only -->
          <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #004085;">📋 Просмотр опубликованного графика</h4>
            <p style="margin: 0; color: #004085; font-size: 0.9em;">
              Здесь отображаются только <strong>опубликованные</strong> смены. Изменения из таблицы планирования становятся видимыми только после нажатия кнопки "Опубликовать".
            </p>
          </div>

          {% if employees and month_dates %}
          <div class="scheduling-container">
            <table class="scheduling-table">
              <thead>
                <tr>
                  <th class="employee-column">Сотрудник</th>
                  {% for work_date in month_dates %}
                  <th class="date-column">{{ work_date.strftime('%d.%m') }}<br><small>
                    {% if work_date.strftime('%a') == 'Mon' %}Пн
                    {% elif work_date.strftime('%a') == 'Tue' %}Вт
                    {% elif work_date.strftime('%a') == 'Wed' %}Ср
                    {% elif work_date.strftime('%a') == 'Thu' %}Чт
                    {% elif work_date.strftime('%a') == 'Fri' %}Пт
                    {% elif work_date.strftime('%a') == 'Sat' %}Сб
                    {% elif work_date.strftime('%a') == 'Sun' %}Вс
                    {% endif %}
                  </small></th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for employee in employees %}
                <tr>
                  <td class="employee-name">
                    {{ employee.full_name or employee.email }}
                    <br><small style="color: #666;">({{ "Админ" if employee.role == "admin" else "Сотрудник" }})</small>
                  </td>
                  {% for work_date in month_dates %}
                  {% set cell_key = employee.id ~ '_' ~ work_date %}
                  {% set existing_shift = schedule_dict[cell_key] %}
                  <td class="shift-cell"
                      data-employee-id="{{ employee.id }}"
                      data-date="{{ work_date }}"
                      data-shift-type="{{ existing_shift.shift_type if existing_shift else '' }}">
                    <div class="shift-content">
                      {% if existing_shift %}
                      <span class="shift-type">
                        {% if existing_shift.shift_type == 'work' %}Р{% elif existing_shift.shift_type == 'off' %}О{% elif existing_shift.shift_type == 'weekend' %}В{% elif existing_shift.shift_type == 'vacation' %}Отп{% elif existing_shift.shift_type == 'sick' %}Б{% endif %}
                      </span>
                      {% if existing_shift.start_time %}
                      <span class="shift-time">{{ existing_shift.start_time.strftime('%H:%M') }}</span>
                      {% endif %}
                      {% else %}
                      <span class="shift-type">-</span>
                      {% endif %}
                    </div>
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Legend for shift types -->
          <div class="shift-legend">
            <div class="legend-item">
              <div class="legend-color" style="background: #d4edda; border: 1px solid #28a745;"></div>
              <span>Рабочий день</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #fff3cd; border: 1px solid #ffc107;"></div>
              <span>Выходной</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f8d7da; border: 1px solid #dc3545;"></div>
              <span>Отгул</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #d1ecf1; border: 1px solid #17a2b8;"></div>
              <span>Отпуск</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #e2e3e5; border: 1px solid #6c757d;"></div>
              <span>Больничный</span>
            </div>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
            <h3 style="color: #6c757d; margin-bottom: 15px;">📭 Нет опубликованных смен</h3>
            <p style="color: #6c757d; margin: 0; font-size: 1.1em;">
              Смены станут видимыми после публикации в разделе "Таблица планирования"
            </p>
            <div style="margin-top: 20px;">
              <a href="/admin/scheduling-table" class="btn btn-primary" style="font-size: 1em; padding: 10px 20px;">
                📅 Перейти к планированию
              </a>
            </div>
          </div>
          {% endif %}

        {% elif active_tab == 'reports' %}
           <h3>📊 Отчеты по рабочему времени</h3>
           {% if message %}<p>{{ message }}</p>{% endif %}

           <!-- Report Type Selection -->
           <div class="form-section">
             <h4>Выберите тип отчета</h4>
             <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
               <a href="/admin/reports?report_type=month" class="btn {{ 'btn-primary' if report_type == 'month' else 'btn-outline-primary' }}">
                 📅 Отчет за месяц
               </a>
               <a href="/admin/reports?report_type=year" class="btn {{ 'btn-primary' if report_type == 'year' else 'btn-outline-primary' }}">
                 📊 Отчет за год
               </a>
               <button type="button" class="btn {{ 'btn-primary' if report_type == 'custom' else 'btn-outline-primary' }}" onclick="toggleCustomDatePicker()">
                 📆 Произвольный интервал
               </button>
             </div>

             <!-- Month/Year Selector for Monthly Reports -->
             {% if report_type == 'month' %}
             <div class="month-selector" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
               <h5 style="margin: 0 0 15px 0; color: #333;">Выберите месяц и год для отчета</h5>
               <form method="get" action="/admin/reports" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                 <input type="hidden" name="report_type" value="month">
                 <div>
                   <label for="month" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Месяц:</label>
                   <select name="month" id="month" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; min-width: 140px;">
                     {% for month_option in months %}
                     <option value="{{ month_option.value }}" {{ 'selected' if month_option.value == selected_month else '' }}>
                       {{ month_option.name }}
                     </option>
                     {% endfor %}
                   </select>
                 </div>
                 <div>
                   <label for="year" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Год:</label>
                   <select name="year" id="year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; min-width: 100px;">
                     {% for year_option in years %}
                     <option value="{{ year_option.value }}" {{ 'selected' if year_option.value == selected_year else '' }}>
                       {{ year_option.name }}
                     </option>
                     {% endfor %}
                   </select>
                 </div>
                 <div style="align-self: flex-end;">
                   <button type="submit" class="btn btn-success" style="padding: 8px 20px; font-size: 0.9em;">
                     📊 Показать отчет
                   </button>
                 </div>
               </form>
               <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                 📅 <strong>Текущий выбор:</strong> {{ months[selected_month-1].name if selected_month else 'Текущий месяц' }} {{ selected_year if selected_year else 'текущий год' }}
               </div>
             </div>
             {% endif %}

             <!-- Custom Date Picker (hidden by default) -->
             <div id="custom-date-picker" class="custom-date-picker {{ 'visible' if report_type == 'custom' else 'hidden' }}">
               <h5>Выберите даты</h5>
               <form method="get" action="/admin/reports" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                 <input type="hidden" name="report_type" value="custom">
                 <div>
                   <label for="start_date" style="display: block; margin-bottom: 5px; font-weight: bold;">Дата начала:</label>
                   <input type="date" id="start_date" name="start_date" value="{{ start_date }}" required class="form-group" style="width: auto;">
                 </div>
                 <div>
                   <label for="end_date" style="display: block; margin-bottom: 5px; font-weight: bold;">Дата окончания:</label>
                   <input type="date" id="end_date" name="end_date" value="{{ end_date }}" required class="form-group" style="width: auto;">
                 </div>
                 <div style="align-self: flex-end;">
                   <button type="submit" class="btn btn-success">📊 Сформировать отчет</button>
                 </div>
               </form>
             </div>

             <!-- Report Summary -->
             {% if report_data %}
             <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
               <h5 style="margin: 0 0 10px 0; color: #155724;">📈 Сводка по отчету</h5>
               <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                 <div><strong>Период:</strong> {{ start_date }} - {{ end_date }}</div>
                 <div><strong>Сотрудников:</strong> {{ total_employees }}</div>
                 <div><strong>Общее время:</strong> {{ total_hours_all }} ч</div>
                 <div><strong>Рабочих смен:</strong> {{ total_shifts_all }}</div>
               </div>
             </div>
             {% endif %}
           </div>

           <!-- Report Table -->
           {% if report_data %}
           <div class="form-section">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
               <h4 style="margin: 0;">Детальный отчет по сотрудникам</h4>
               <a href="/admin/reports/export?report_type={{ report_type }}&start_date={{ start_date }}&end_date={{ end_date }}{% if report_type == 'month' %}&month={{ selected_month }}&year={{ selected_year }}{% endif %}" class="btn btn-success">
                 📥 Скачать Excel
               </a>
             </div>

             <div style="overflow-x: auto;">
               <table class="table">
                 <thead>
                   <tr>
                     <th>Сотрудник</th>
                     <th>Источник</th>
                     <th>Рабочие часы</th>
                     <th>Рабочие смены</th>
                     <th>Рабочие дни<br><small>(по графику)</small></th>
                     <th>Отгулы</th>
                     <th>Отпуска</th>
                     <th>Больничные</th>
                     <th>Среднее время<br><small>за смену</small></th>
                   </tr>
                 </thead>
                 <tbody>
                   {% for data in report_data %}
                   <tr>
                     <td>
                       <strong>{{ data.employee.full_name or data.employee.email }}</strong>
                       <br><small style="color: #666;">{{ data.employee.email }}</small>
                     </td>
                     <td>
                       {% if '@bot.local' in data.employee.email %}
                       <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">🤖 Бот</span>
                       {% else %}
                       <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">🌐 Веб</span>
                       {% endif %}
                     </td>
                     <td>
                       <span style="font-weight: bold; color: #007bff;">{{ data.total_hours }} ч</span>
                     </td>
                     <td>
                       <span style="font-weight: bold; color: #28a745;">{{ data.working_shifts }}</span>
                     </td>
                     <td>
                       <span style="color: #17a2b8;">{{ data.work_days }}</span>
                     </td>
                     <td>
                       <span style="color: #ffc107;">{{ data.days_off }}</span>
                     </td>
                     <td>
                       <span style="color: #6f42c1;">{{ data.vacations }}</span>
                     </td>
                     <td>
                       <span style="color: #dc3545;">{{ data.sick_days }}</span>
                     </td>
                     <td>
                       {% if data.working_shifts > 0 %}
                       <span style="color: #20c997;">{{ "%.1f"|format(data.total_hours / data.working_shifts) }} ч</span>
                       {% else %}
                       <span style="color: #6c757d;">-</span>
                       {% endif %}
                     </td>
                   </tr>
                   {% endfor %}
                 </tbody>
                 <tfoot>
                   <tr style="background: #f8f9fa; font-weight: bold;">
                     <td><strong>ИТОГО</strong></td>
                     <td style="text-align: center; color: #6c757d;">-</td>
                     <td><strong style="color: #007bff;">{{ total_hours_all }} ч</strong></td>
                     <td><strong style="color: #28a745;">{{ total_shifts_all }}</strong></td>
                     <td colspan="4" style="text-align: center; color: #6c757d;">-</td>
                     <td>
                       {% if total_shifts_all > 0 %}
                       <strong style="color: #20c997;">{{ "%.1f"|format(total_hours_all / total_shifts_all) }} ч</strong>
                       {% else %}
                       <strong style="color: #6c757d;">-</strong>
                       {% endif %}
                     </td>
                   </tr>
                 </tfoot>
               </table>
             </div>
           </div>
           {% else %}
           <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
             <h4 style="color: #6c757d; margin-bottom: 15px;">📭 Нет данных для отображения</h4>
             <p style="color: #6c757d; margin: 0;">
               Выберите тип отчета и период для формирования статистики
             </p>
           </div>
           {% endif %}

        {% elif active_tab == 'stores' %}
          <h3>🏢 Управление магазинами</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          
          <!-- Форма создания магазина -->
          <div class="form-section">
            <h4>Добавить новый магазин</h4>
            <form method="post" action="/admin/stores/create">
              <div class="form-group">
                <label for="name">Название магазина:</label>
                <input type="text" id="name" name="name" required>
              </div>
              
              <div class="form-group">
                <label for="address">Адрес:</label>
                <input type="text" id="address" name="address">
              </div>
              
              <div class="form-group">
                <label for="phone">Телефон:</label>
                <input type="text" id="phone" name="phone">
              </div>
              
              <button type="submit" class="btn btn-primary">Добавить магазин</button>
            </form>
          </div>
          
          <!-- Список магазинов -->
          {% if stores %}
          <div class="form-section">
            <h4>Список магазинов</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>Название</th>
                  <th>Адрес</th>
                  <th>Телефон</th>
                </tr>
              </thead>
              <tbody>
                {% for store in stores %}
                <tr>
                  <td>{{ store.name }}</td>
                  <td>{{ store.address or 'Не указан' }}</td>
                  <td>{{ store.phone or 'Не указан' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>Нет зарегистрированных магазинов.</p>
          {% endif %}

       {% elif active_tab == 'attendance' %}
          <h3>⏰ Редактирование присутствия</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <!-- Success/Error Messages -->
          {% if request.query_params.get('success') == 'created' %}
          <div class="alert alert-success">
            ✅ Запись о присутствии успешно создана!
          </div>
          {% elif request.query_params.get('success') == 'updated' %}
          <div class="alert alert-success">
            ✅ Запись о присутствии успешно обновлена!
          </div>
          {% elif request.query_params.get('success') == 'deleted' %}
          <div class="alert alert-success">
            ✅ Запись о присутствии успешно удалена!
          </div>
          {% elif request.query_params.get('error') == 'no_start_time' %}
          <div class="alert alert-danger">
            ❌ Необходимо указать время прихода!
          </div>
          {% elif request.query_params.get('error') == 'server_error' %}
          <div class="alert alert-danger">
            ❌ Произошла ошибка сервера!
          </div>
          {% endif %}

          <!-- Employee and Date Selection -->
          <div class="form-section">
            <h4>Выбор сотрудника и даты</h4>
            <form method="get" action="/admin/attendance" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
              <div>
                <label for="employee_id" style="display: block; margin-bottom: 5px; font-weight: bold;">Сотрудник:</label>
                <select name="employee_id" id="employee_id" class="form-group" style="width: 250px;" required>
                  <option value="">-- Выберите сотрудника --</option>
                  {% for employee in employees %}
                  <option value="{{ employee.id }}" {{ 'selected' if selected_employee_id and selected_employee_id == employee.id else '' }}>
                    {{ employee.full_name or employee.email }} ({{ employee.email }})
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="selected_date" style="display: block; margin-bottom: 5px; font-weight: bold;">Дата:</label>
                <input type="date" name="selected_date" id="selected_date" value="{{ selected_date or '' }}" class="form-group" required>
              </div>
              <div>
                <button type="submit" class="btn btn-primary">🔍 Найти запись</button>
              </div>
            </form>
          </div>

          <!-- Attendance Editing Form -->
          {% if selected_employee_id and selected_date %}
          <div class="form-section">
            <h4>Редактирование времени присутствия</h4>

            {% if attendance_record %}
            <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <h5 style="margin: 0 0 10px 0; color: #155724;">📝 Существующая запись</h5>
              <p style="margin: 0; color: #155724;">
                <strong>Приход:</strong> {{ attendance_record.started_at.strftime('%H:%M') if attendance_record.started_at else 'Не указано' }}<br>
                <strong>Уход:</strong> {{ attendance_record.ended_at.strftime('%H:%M') if attendance_record.ended_at else 'Не указано' }}<br>
                <strong>Часы работы:</strong> {{ "%.2f"|format(attendance_record.hours) if attendance_record.hours else 'Не рассчитано' }}
              </p>
            </div>
            {% else %}
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <h5 style="margin: 0 0 10px 0; color: #856404;">📝 Новая запись</h5>
              <p style="margin: 0; color: #856404;">
                Для выбранного сотрудника и даты записи о присутствии не найдено. Вы можете создать новую запись.
              </p>
            </div>
            {% endif %}

            <form method="post" action="/admin/attendance/save">
              <input type="hidden" name="employee_id" value="{{ selected_employee_id }}">
              <input type="hidden" name="work_date" value="{{ selected_date }}">

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                  <label for="start_time">Время прихода:</label>
                  <input type="time" id="start_time" name="start_time"
                         value="{{ attendance_record.started_at.strftime('%H:%M') if attendance_record and attendance_record.started_at else '' }}"
                         class="form-group">
                </div>
                <div class="form-group">
                  <label for="end_time">Время ухода:</label>
                  <input type="time" id="end_time" name="end_time"
                         value="{{ attendance_record.ended_at.strftime('%H:%M') if attendance_record and attendance_record.ended_at else '' }}"
                         class="form-group">
                </div>
              </div>

              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="submit" class="btn btn-success">
                  💾 {{ 'Обновить' if attendance_record else 'Создать' }} запись
                </button>

                {% if attendance_record %}
                <a href="/admin/attendance/delete/{{ attendance_record.id }}" class="btn btn-danger"
                   onclick="return confirm('Удалить запись о присутствии?')">
                  🗑️ Удалить запись
                </a>
                {% endif %}

                <a href="/admin/attendance" class="btn btn-secondary">🔄 Сбросить</a>
              </div>
            </form>
          </div>
          {% endif %}

          <!-- Recent Attendance Records -->
          {% if recent_attendances %}
          <div class="form-section">
            <h4>🕐 Последние записи о присутствии</h4>
            <div style="overflow-x: auto;">
              <table class="table">
                <thead>
                  <tr>
                    <th>Сотрудник</th>
                    <th>Дата</th>
                    <th>Приход</th>
                    <th>Уход</th>
                    <th>Часы</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody>
                  {% for attendance in recent_attendances %}
                  <tr>
                    <td>
                      <strong>{{ attendance.user.full_name or attendance.user.email }}</strong>
                      <br><small style="color: #666;">{{ attendance.user.email }}</small>
                    </td>
                    <td>{{ attendance.work_date.strftime('%d.%m.%Y') }}</td>
                    <td>{{ attendance.started_at.strftime('%H:%M') if attendance.started_at else '-' }}</td>
                    <td>{{ attendance.ended_at.strftime('%H:%M') if attendance.ended_at else '-' }}</td>
                    <td>{{ "%.2f"|format(attendance.hours) if attendance.hours else '-' }}</td>
                    <td>
                      <a href="/admin/attendance?employee_id={{ attendance.user_id }}&selected_date={{ attendance.work_date }}"
                         class="btn btn-sm btn-primary" style="padding: 3px 8px; font-size: 0.8em;">
                        ✏️ Редактировать
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

        {% elif active_tab == 'allowed_ips' %}
          <h3>🔒 Управление разрешенными IP адресами</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <!-- Уведомления об успешных операциях -->
          {% if request.query_params.get('success') == 'created' %}
          <div class="alert alert-success">
            ✅ IP адрес успешно добавлен!
          </div>
          {% elif request.query_params.get('success') == 'deleted' %}
          <div class="alert alert-success">
            ✅ IP адрес успешно удален!
          </div>
          {% elif request.query_params.get('success') == 'status_changed' %}
          <div class="alert alert-success">
            ✅ Статус IP адреса успешно изменен!
          </div>
          {% elif request.query_params.get('error') == 'ip_exists' %}
          <div class="alert alert-danger">
            ❌ Этот IP адрес уже существует!
          </div>
          {% elif request.query_params.get('error') == 'ip_exists' %}
          <div class="alert alert-danger">
            ❌ Этот IP адрес уже существует!
          </div>
          {% elif request.query_params.get('error') == 'server_error' %}
          <div class="alert alert-danger">
            ❌ Произошла ошибка сервера!
          </div>
          {% elif request.query_params.get('error') == 'delete_error' %}
          <div class="alert alert-danger">
            ❌ Ошибка при удалении IP адреса!
          </div>
          {% elif request.query_params.get('error') == 'status_error' %}
          <div class="alert alert-danger">
            ❌ Ошибка при изменении статуса IP адреса!
          </div>
          {% endif %}

          <!-- Форма добавления нового IP -->
          <div class="form-section">
            <h4>Добавить новый разрешенный IP адрес</h4>
            <form method="post" action="/admin/allowed-ips/create">
              <div class="form-group">
                <label for="ip_address">IP адрес:</label>
                <input type="text" id="ip_address" name="ip_address" required
                       placeholder="192.168.1.1 или 2001:db8::1" pattern="^(\d{1,3}\.){3}\d{1,3}$|^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$"
                       title="Введите корректный IPv4 или IPv6 адрес">
              </div>

              <div class="form-group">
                <label for="description">Описание (опционально):</label>
                <input type="text" id="description" name="description" placeholder="Например: Офисная сеть">
              </div>

              <button type="submit" class="btn btn-primary">➕ Добавить IP адрес</button>
            </form>
          </div>

          <!-- Список разрешенных IP -->
          {% if allowed_ips %}
          <div class="form-section">
            <h4>Список разрешенных IP адресов</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>IP адрес</th>
                  <th>Описание</th>
                  <th>Статус</th>
                  <th>Дата создания</th>
                  <th>Создал</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for ip in allowed_ips %}
                <tr>
                  <td>
                    <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace;">
                      {{ ip.ip_address }}
                    </code>
                  </td>
                  <td>{{ ip.description or 'Без описания' }}</td>
                  <td>
                    <span class="btn {{ 'btn-success' if ip.is_active else 'btn-danger' }}" style="padding: 3px 8px; font-size: 0.8em;">
                      {{ 'Активен' if ip.is_active else 'Неактивен' }}
                    </span>
                  </td>
                  <td>{{ ip.created_at.strftime('%d.%m.%Y %H:%M') if ip.created_at else 'Неизвестно' }}</td>
                  <td>{{ ip.creator.full_name if ip.creator else 'Система' }}</td>
                  <td>
                    <!-- Кнопка изменения статуса -->
                    <form method="post" action="/admin/allowed-ips/toggle/{{ ip.id }}" style="display: inline-block; margin-right: 5px;">
                      <button type="submit" class="btn {{ 'btn-warning' if ip.is_active else 'btn-success' }}"
                              style="padding: 3px 8px; font-size: 0.8em;">
                        {{ 'Деактивировать' if ip.is_active else 'Активировать' }}
                      </button>
                    </form>

                    <!-- Кнопка удаления -->
                    <form method="post" action="/admin/allowed-ips/delete/{{ ip.id }}" style="display: inline-block;">
                      <button type="submit" class="btn btn-danger" style="padding: 3px 8px; font-size: 0.8em;">
                        🗑️ Удалить
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #6c757d; margin-bottom: 15px;">📭 Нет разрешенных IP адресов</h4>
            <p style="color: #6c757d; margin: 0;">
              Добавьте первый IP адрес с помощью формы выше
            </p>
          </div>
          {% endif %}

        {% else %}
          <h3>Добро пожаловать в админ панель!</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          <p>Выберите раздел в навигации выше.</p>
        {% endif %}
      </div>
    </div>

    <script>
      let isSelecting = false;
      let isPainting = false;
      let isMouseDown = false;
      let startCell = null;
      let selectedCells = [];
      let currentShiftType = '';
      let paintShiftType = '';

      let clickCount = 0;
      let clickTimer = null;

      function handleCellClick(cell) {
        if (isSelecting) return;

        clickCount++;

        if (clickCount === 1) {
          // Single click - show menu
          clickTimer = setTimeout(() => {
            clickCount = 0;
            // Menu will be shown via CSS hover
          }, 300);
        } else if (clickCount === 2) {
          // Double click - set to weekend
          clearTimeout(clickTimer);
          clickCount = 0;
          quickSetWeekend(cell);
        }
      }

      async function quickSetWeekend(cell) {
        const employeeId = cell.dataset.employeeId;
        const workDate = cell.dataset.date;
        const defaultStore = document.getElementById('default_store')?.value || '';

        // Visual feedback
        cell.style.opacity = '0.6';

        try {
          const formData = new FormData();
          formData.append('employee_id', employeeId);
          formData.append('work_date', workDate);
          formData.append('shift_type', 'weekend');
          if (defaultStore) {
            formData.append('store_id', defaultStore);
          }

          const response = await fetch('/admin/scheduling-table/toggle', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // Update cell appearance immediately
            cell.dataset.shiftType = 'weekend';
            updateCellContent(cell, 'weekend');

            // Reload page after short delay
            setTimeout(() => {
              window.location.reload();
            }, 200);
          } else {
            alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
          }
        } catch (error) {
          console.error('Ошибка при быстром назначении выходного:', error);
          alert('Произошла ошибка при обработке запроса');
        } finally {
          cell.style.opacity = '1';
        }
      }

      function updateCellContent(cell, shiftType) {
        const content = cell.querySelector('.shift-content');
        if (content) {
          const typeSpan = content.querySelector('.shift-type');
          if (typeSpan) {
            if (shiftType === 'work') typeSpan.textContent = 'Р';
            else if (shiftType === 'off') typeSpan.textContent = 'О';
            else if (shiftType === 'weekend') typeSpan.textContent = 'В';
            else if (shiftType === 'vacation') typeSpan.textContent = 'Отп';
            else if (shiftType === 'sick') typeSpan.textContent = 'Б';
            else typeSpan.textContent = '-';
          }
        }
      }

      function startSelection(cell) {
        isMouseDown = true;

        if (event.shiftKey) {
          // Начинаем множественный выбор
          isSelecting = true;
          startCell = cell;
          selectedCells = [cell];
          cell.classList.add('selected');
          currentShiftType = cell.dataset.shiftType || '';

          // Создаем overlay для визуализации выбора
          createSelectionOverlay();

          event.preventDefault();
        } else {
          // Начинаем рисование (копирование типа смены)
          isPainting = true;
          paintShiftType = cell.dataset.shiftType || 'work';

          // Визуальная обратная связь
          cell.classList.add('painting');

          event.preventDefault();
        }
      }

      function extendSelection(cell) {
        if (!isMouseDown) return; // Прекращаем если кнопка мыши отпущена

        if (isSelecting && startCell) {
          // Множественный выбор с Shift
          // Очищаем предыдущий выбор
          selectedCells.forEach(c => c.classList.remove('selected'));
          selectedCells = [];

          // Получаем координаты начальной и текущей ячейки
          const startRect = startCell.getBoundingClientRect();
          const currentRect = cell.getBoundingClientRect();
          const table = startCell.closest('table');
          const allCells = Array.from(table.querySelectorAll('.shift-cell'));

          // Находим все ячейки в прямоугольнике выбора
          const minLeft = Math.min(startRect.left, currentRect.left);
          const maxRight = Math.max(startRect.right, currentRect.right);
          const minTop = Math.min(startRect.top, currentRect.top);
          const maxBottom = Math.max(startRect.bottom, currentRect.bottom);

          allCells.forEach(cell => {
            const cellRect = cell.getBoundingClientRect();
            if (cellRect.left >= minLeft && cellRect.right <= maxRight &&
                cellRect.top >= minTop && cellRect.bottom <= maxBottom) {
              cell.classList.add('selected');
              selectedCells.push(cell);
            }
          });

          // Обновляем overlay
          updateSelectionOverlay(minLeft, minTop, maxRight - minLeft, maxBottom - minTop);
        } else if (isPainting && cell !== startCell) {
          // Рисование (копирование типа смены)
          paintCell(cell);
        }
      }

      async function paintCell(cell) {
        const currentType = cell.dataset.shiftType;
        if (currentType === paintShiftType) return; // Уже правильный тип

        const employeeId = cell.dataset.employeeId;
        const workDate = cell.dataset.date;
        const defaultStore = document.getElementById('default_store')?.value || '';

        try {
          const formData = new FormData();
          formData.append('employee_id', employeeId);
          formData.append('work_date', workDate);
          formData.append('shift_type', paintShiftType);
          if (defaultStore) {
            formData.append('store_id', defaultStore);
          }

          // Определяем время в зависимости от типа смены
          if (paintShiftType === 'work') {
            formData.append('start_time', '09:00');
            formData.append('end_time', '17:00');
          }

          const response = await fetch('/admin/scheduling-table/toggle', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // Обновляем ячейку визуально
            cell.dataset.shiftType = paintShiftType;
            updateCellContent(cell, paintShiftType);
            cell.classList.add('painted');
          }
        } catch (error) {
          console.error('Ошибка при рисовании смены:', error);
        }
      }

      function createSelectionOverlay() {
        const overlay = document.createElement('div');
        overlay.className = 'selection-overlay';
        overlay.id = 'selection-overlay';
        document.body.appendChild(overlay);
      }

      function updateSelectionOverlay(left, top, width, height) {
        const overlay = document.getElementById('selection-overlay');
        if (overlay) {
          overlay.style.left = left + 'px';
          overlay.style.top = top + 'px';
          overlay.style.width = width + 'px';
          overlay.style.height = height + 'px';
        }
      }

      function selectShiftType(event, button, employeeId, workDate) {
        event.stopPropagation();
        const shiftType = button.dataset.value;
        const defaultStore = document.getElementById('default_store')?.value || '';

        // Если есть выбранные ячейки (множественный выбор), применяем ко всем
        if (selectedCells.length > 1) {
          applyShiftToMultipleCells(shiftType, defaultStore);
        } else {
          // Одиночный выбор
          applyShiftToCell(employeeId, workDate, shiftType, defaultStore);
        }

        // Очищаем выбор
        clearSelection();
      }

      async function applyShiftToCell(employeeId, workDate, shiftType, storeId) {
        try {
          const formData = new FormData();
          formData.append('employee_id', employeeId);
          formData.append('work_date', workDate);
          formData.append('shift_type', shiftType);
          if (storeId) {
            formData.append('store_id', storeId);
          }

          // Определяем время в зависимости от типа смены
          if (shiftType === 'work') {
            formData.append('start_time', '09:00');
            formData.append('end_time', '17:00');
          }

          const response = await fetch('/admin/scheduling-table/toggle', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // Перезагружаем страницу для обновления данных
            setTimeout(() => {
              window.location.reload();
            }, 200);
          } else {
            alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
          }
        } catch (error) {
          console.error('Ошибка при изменении типа смены:', error);
          alert('Произошла ошибка при обработке запроса');
        }
      }

      async function applyShiftToMultipleCells(shiftType, storeId) {
        const promises = selectedCells.map(cell => {
          const employeeId = cell.dataset.employeeId;
          const workDate = cell.dataset.date;
          return applyShiftToCell(employeeId, workDate, shiftType, storeId);
        });

        try {
          await Promise.all(promises);
          setTimeout(() => {
            window.location.reload();
          }, 200);
        } catch (error) {
          console.error('Ошибка при массовом изменении смен:', error);
          alert('Произошла ошибка при обработке запроса');
        }
      }

      function clearSelection() {
        isSelecting = false;
        isPainting = false;
        isMouseDown = false;
        startCell = null;

        // Очищаем выделенные ячейки
        selectedCells.forEach(cell => {
          cell.classList.remove('selected');
          cell.classList.remove('painting');
          cell.classList.remove('painted');
        });
        selectedCells = [];

        // Удаляем overlay
        const overlay = document.getElementById('selection-overlay');
        if (overlay) {
          overlay.remove();
        }
      }

      // Глобальные обработчики событий мыши
      document.addEventListener('mousedown', function(e) {
        // Отслеживаем нажатие левой кнопки мыши
        if (e.button === 0) { // Левая кнопка
          isMouseDown = true;
        }
      });

      document.addEventListener('mouseup', function(e) {
        // Отслеживаем отпускание левой кнопки мыши
        if (e.button === 0) { // Левая кнопка
          isMouseDown = false;
          if (isSelecting || isPainting) {
            clearSelection();
          }
        }
      });

      // Очищаем выбор при клике вне таблицы
      document.addEventListener('mouseup', function() {
        if (isSelecting) {
          clearSelection();
        }
      });

      // Предотвращаем выделение текста при множественном выборе
      document.addEventListener('selectstart', function(e) {
        if (isSelecting) {
          e.preventDefault();
        }
      });

      // Функция для публикации расписания
      async function publishSchedule() {
        const publishButton = document.querySelector('button[onclick="publishSchedule()"]');
        const statusDiv = document.getElementById('publish-status');

        // Получаем текущие параметры месяца и года
        const urlParams = new URLSearchParams(window.location.search);
        const month = urlParams.get('month') || new Date().getMonth() + 1;
        const year = urlParams.get('year') || new Date().getFullYear();

        // Показываем загрузку
        publishButton.disabled = true;
        publishButton.textContent = '⏳ Публикуем...';
        statusDiv.innerHTML = '<span style="color: #007bff;">Публикуем расписание...</span>';

        try {
          const formData = new FormData();
          formData.append('month', month);
          formData.append('year', year);

          const response = await fetch('/admin/scheduling-table/publish', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            statusDiv.innerHTML = `<span style="color: #28a745;">✅ ${result.message}</span>`;

            // Показываем уведомление
            showNotification(`Расписание опубликовано! ${result.published_count} смен стали видимыми для сотрудников.`, 'success');

            // Обновляем страницу через 2 секунды
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            statusDiv.innerHTML = `<span style="color: #dc3545;">❌ Ошибка: ${result.error}</span>`;
            showNotification('Ошибка при публикации расписания', 'error');
          }
        } catch (error) {
          console.error('Ошибка при публикации:', error);
          statusDiv.innerHTML = '<span style="color: #dc3545;">❌ Произошла ошибка при публикации</span>';
          showNotification('Ошибка при публикации расписания', 'error');
        } finally {
          // Восстанавливаем кнопку
          publishButton.disabled = false;
          publishButton.textContent = '🚀 Опубликовать расписание';
        }
      }

      // Функция для показа уведомлений
      function showNotification(message, type = 'info') {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
          color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
          border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
          padding: 15px 20px;
          border-radius: 5px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          z-index: 10000;
          font-weight: 500;
          max-width: 400px;
          animation: slideIn 0.3s ease-out;
        `;

        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
            <span>${message}</span>
          </div>
        `;

        // Добавляем анимацию
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        // Автоматически удаляем через 5 секунд
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 5000);

        // Добавляем анимацию исчезновения
        setTimeout(() => {
          const slideOutStyle = document.createElement('style');
          slideOutStyle.textContent = `
            @keyframes slideOut {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(100%); opacity: 0; }
            }
          `;
          document.head.appendChild(slideOutStyle);
        }, 4500);
      }

      // Функция для подтверждения действий
      function confirmAction(message) {
        return confirm(message);
      }

      // Функция для назначения магазина сотруднику
      function submitStoreAssignment(selectElement, employeeName) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const storeName = selectedOption.text;
        const storeId = selectElement.value;

        let message = '';
        if (storeId === '') {
          message = `Снять назначение магазина для сотрудника "${employeeName}"?`;
        } else {
          message = `Назначить магазин "${storeName}" сотруднику "${employeeName}"?`;
        }

        if (confirm(message)) {
          // Находим форму и отправляем её
          const form = selectElement.closest('form');
          if (form) {
            form.submit();
          }
        } else {
          // Возвращаем предыдущее значение
          const previousValue = selectElement.getAttribute('data-previous-value') || '';
          selectElement.value = previousValue;
        }
      }

      // Сохраняем предыдущие значения для select элементов
      document.addEventListener('DOMContentLoaded', function() {
        // Сохраняем предыдущие значения для селекторов магазинов
        const storeSelects = document.querySelectorAll('select[name="store_id"]');
        storeSelects.forEach(select => {
          select.addEventListener('focus', function() {
            this.setAttribute('data-previous-value', this.value);
          });
        });
      });

      // Function to count and display schedule status
      function updateScheduleCounts() {
        const draftCount = document.querySelectorAll('.shift-cell.draft').length;
        const publishedCount = document.querySelectorAll('.shift-cell.published').length;
        const totalCount = draftCount + publishedCount;

        document.getElementById('draft-count').textContent = draftCount;
        document.getElementById('published-count').textContent = publishedCount;
        document.getElementById('total-count').textContent = totalCount;
      }

      // Function to toggle custom date picker
      function toggleCustomDatePicker() {
        const picker = document.getElementById('custom-date-picker');
        if (picker) {
          if (picker.classList.contains('hidden')) {
            picker.classList.remove('hidden');
            picker.classList.add('visible');
          } else {
            picker.classList.remove('visible');
            picker.classList.add('hidden');
          }
        }
      }

      // Ensure select dropdowns work properly
      document.addEventListener('DOMContentLoaded', function() {
        // Update counts on page load
        updateScheduleCounts();

        // Add mouse leave handler for scheduling table to stop painting when mouse leaves
        const schedulingTable = document.querySelector('.scheduling-table');
        if (schedulingTable) {
          schedulingTable.addEventListener('mouseleave', function() {
            if (isPainting && !isMouseDown) {
              clearSelection();
            }
          });
        }

        // Fix for select dropdowns
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
          select.addEventListener('mousedown', function(e) {
            // Prevent default behavior that might interfere
            e.stopPropagation();
          });

          select.addEventListener('change', function() {
            console.log('Select changed:', this.name, this.value);
          });
        });

        // Debug form submission
        const monthForm = document.querySelector('form[action="/admin/scheduling-table"]');
        if (monthForm) {
          monthForm.addEventListener('submit', function(e) {
            console.log('Form submitted with month:', this.month.value, 'year:', this.year.value);
            // Add visual feedback
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.textContent = 'Загрузка...';
              submitBtn.disabled = true;
            }
          });
        }

        // Test select functionality
        const testSelect = document.querySelector('select[name="month"]');
        if (testSelect) {
          testSelect.addEventListener('change', function() {
            console.log('Month select changed to:', this.value);
          });
        }
      });
    </script>
  </body>
</html>
