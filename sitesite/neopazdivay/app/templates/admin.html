<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" }}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .nav a {
        padding: 10px 15px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
      .nav a:hover {
        background: #0056b3;
      }
      .nav a.active {
        background: #28a745;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #007bff;
        text-decoration: none;
      }
      .back-link:hover {
        text-decoration: underline;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #007bff;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        color: #666;
        margin-top: 5px;
      }
      .form-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box;
      }
      .form-group select {
        background: white;
        cursor: pointer;
        appearance: auto;
        -webkit-appearance: auto;
        -moz-appearance: auto;
      }
      .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
      }

      /* Month selector specific styles */
      .month-selector select {
        min-width: 120px;
        margin: 0 5px;
      }

      .month-selector .btn {
        margin-left: 10px;
      }
      .form-group textarea {
        height: 80px;
        resize: vertical;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 1em;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background: #0056b3;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-success:hover {
        background: #218838;
      }
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      .btn-warning:hover {
        background: #e0a800;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .table th, .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .table th {
        background: #f8f9fa;
        font-weight: bold;
      }
      .table tr:hover {
        background: #f5f5f5;
      }
      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .schedule-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }
      .schedule-date {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }
      .schedule-item {
        background: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .schedule-item:last-child {
        margin-bottom: 0;
      }
      .employee-name {
        font-weight: bold;
        color: #007bff;
      }
      .time-range {
        color: #666;
        font-size: 0.9em;
      }
      .notes {
        color: #666;
        font-style: italic;
        margin-top: 5px;
      }
      .scheduling-container {
        overflow-x: auto;
        margin-top: 15px;
        max-width: 100%;
      }
      .scheduling-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75em;
        line-height: 1.2;
      }
      .scheduling-table th, .scheduling-table td {
        border: 1px solid #ddd;
        padding: 3px 4px;
        text-align: center;
        vertical-align: middle;
      }
      .scheduling-table th {
        background: #f8f9fa;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.7em;
        padding: 4px 2px;
      }
      .employee-column {
        min-width: 120px;
        max-width: 140px;
        text-align: left;
        position: sticky;
        left: 0;
        background: #f8f9fa;
        z-index: 20;
        font-size: 0.7em;
        padding: 4px 6px;
      }
      .date-column {
        min-width: 45px;
        max-width: 50px;
        font-size: 0.65em;
        padding: 2px;
      }
      .shift-cell {
        width: 35px;
        height: 28px;
        padding: 1px !important;
        text-align: center;
        border: 1px solid #ddd;
        cursor: pointer;
        position: relative;
        user-select: none;
        font-size: 0.65em;
      }
      .shift-cell:hover {
        border-color: #007bff;
      }
      .shift-cell.selected {
        background: #007bff !important;
        color: white;
        border-color: #0056b3;
      }
      .shift-cell.dragging {
        border-color: #2196f3;
      }
      .shift-cell.painting {
        box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        border-color: #2196f3;
      }
      .shift-cell.painted {
        animation: paintFlash 0.3s ease-out;
      }
      @keyframes paintFlash {
        0% { background-color: rgba(33, 150, 243, 0.3); }
        100% { background-color: inherit; }
      }

      /* Color coding for different shift types */
      .shift-cell[data-shift-type="work"] {
        background: #d4edda;
        border-color: #28a745;
      }
      .shift-cell[data-shift-type="work"]:hover {
        background: #c3e6cb;
        border-color: #1e7e34;
      }

      .shift-cell[data-shift-type="weekend"] {
        background: #fff3cd;
        border-color: #ffc107;
      }
      .shift-cell[data-shift-type="weekend"]:hover {
        background: #ffeaa7;
        border-color: #d39e00;
      }

      .shift-cell[data-shift-type="off"] {
        background: #f8d7da;
        border-color: #dc3545;
      }
      .shift-cell[data-shift-type="off"]:hover {
        background: #f5c6cb;
        border-color: #bd2130;
      }

      .shift-cell[data-shift-type="vacation"] {
        background: #d1ecf1;
        border-color: #17a2b8;
      }
      .shift-cell[data-shift-type="vacation"]:hover {
        background: #bee5eb;
        border-color: #117a8b;
      }

      .shift-cell[data-shift-type="sick"] {
        background: #e2e3e5;
        border-color: #6c757d;
      }
      .shift-cell[data-shift-type="sick"]:hover {
        background: #d6d8db;
        border-color: #545b62;
      }

      /* Draft/Published indicators */
      .shift-cell.draft {
        position: relative;
      }
      .shift-cell.published {
        position: relative;
      }
      .shift-cell.published::after {
        content: "‚úì";
        position: absolute;
        top: -2px;
        right: -2px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        font-size: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 1px solid white;
      }
      .draft-indicator {
        position: absolute;
        top: -2px;
        right: -2px;
        font-size: 10px;
        opacity: 0.8;
      }
      .shift-content {
        position: relative;
        z-index: 1;
      }

      /* Override selected state for colored cells */
      .shift-cell.selected[data-shift-type] {
        background: #007bff !important;
        color: white;
        border-color: #0056b3;
      }
      .shift-content {
        font-size: 0.6em;
        font-weight: bold;
        line-height: 1.1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #333;
        padding: 1px 0;
      }
      .shift-type {
        display: block;
        margin-bottom: 0px;
      }
      .shift-time {
        display: block;
        font-size: 0.5em;
        opacity: 0.8;
        line-height: 1;
      }

      /* Text colors for better contrast on colored backgrounds */
      .shift-cell[data-shift-type="work"] .shift-content,
      .shift-cell[data-shift-type="weekend"] .shift-content,
      .shift-cell[data-shift-type="off"] .shift-content,
      .shift-cell[data-shift-type="vacation"] .shift-content,
      .shift-cell[data-shift-type="sick"] .shift-content {
        color: #333;
      }

      /* Special text color for weekend (yellow background) */
      .shift-cell[data-shift-type="weekend"] .shift-content {
        color: #856404;
      }
      .shift-dropdown-container {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        border-radius: 3px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        min-width: 90px;
        max-width: 120px;
      }
      .shift-cell:hover .shift-dropdown-container {
        display: block;
      }
      .shift-dropdown {
        width: 100%;
        padding: 3px 5px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 0.65em;
        text-align: left;
        line-height: 1.2;
      }
      .shift-dropdown:hover {
        background: #f8f9fa;
      }
      .shift-dropdown:focus {
        outline: none;
        background: #e3f2fd;
      }
      .shift-info {
        display: none;
      }
      .selection-overlay {
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 123, 255, 0.1);
        border: 2px solid #007bff;
        pointer-events: none;
        z-index: 999;
      }

      /* Legend styling */
      .shift-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        font-size: 0.75em;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8em;
        font-weight: 500;
      }
      .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 2px;
      }
      .legend-item span {
        color: #495057;
      }

      /* Custom date picker styles */
      .custom-date-picker {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
      }
      .custom-date-picker.hidden {
        display: none;
      }
      .custom-date-picker.visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/dashboard" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ dashboard</a>
      
      <h1>‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
      
      <div class="nav">
        <a href="/admin" class="{{ 'active' if active_tab == 'dashboard' else '' }}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/admin/employees" class="{{ 'active' if active_tab == 'employees' else '' }}">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
        <a href="/admin/scheduling-table" class="{{ 'active' if active_tab == 'scheduling_table' else '' }}">–¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</a>
        <a href="/admin/schedule" class="{{ 'active' if active_tab == 'schedule' else '' }}">–ì—Ä–∞—Ñ–∏–∫</a>
        <a href="/admin/attendance" class="{{ 'active' if active_tab == 'attendance' else '' }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</a>
        <a href="/admin/reports" class="{{ 'active' if active_tab == 'reports' else '' }}">–û—Ç—á–µ—Ç—ã</a>
        <a href="/admin/stores" class="{{ 'active' if active_tab == 'stores' else '' }}">–ú–∞–≥–∞–∑–∏–Ω—ã</a>
        <a href="/admin/allowed-ips" class="{{ 'active' if active_tab == 'allowed_ips' else '' }}">–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ IP</a>
      </div>

      <div class="content">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö -->
        {% if request.query_params.get('success') == 'store_assigned' %}
        <div class="alert alert-success">
          ‚úÖ –ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É!
        </div>
        {% elif request.query_params.get('success') == 'status_changed' %}
        <div class="alert alert-success">
          ‚úÖ –°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!
        </div>
        {% elif request.query_params.get('error') == 'employee_not_found' %}
        <div class="alert alert-danger">
          ‚ùå –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!
        </div>
        {% elif request.query_params.get('error') == 'server_error' %}
        <div class="alert alert-danger">
          ‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!
        </div>
        {% endif %}

        {% if active_tab == 'dashboard' %}
          <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          
          {% if stats %}
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_users }}</div>
              <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_employees }}</div>
              <div class="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_admins }}</div>
              <div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.total_stores }}</div>
              <div class="stat-label">–ú–∞–≥–∞–∑–∏–Ω–æ–≤</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">{{ stats.today_schedules }}</div>
              <div class="stat-label">–°–º–µ–Ω —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
          </div>
          {% endif %}

        {% elif active_tab == 'employees' %}
          <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          
          {% if employees %}
          <div class="form-section">
            <h4>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>–ò–º—è</th>
                  <th>Email</th>
                  <th>–†–æ–ª—å</th>
                  <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                  <th>–ú–∞–≥–∞–∑–∏–Ω</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                {% for employee in employees %}
                <tr>
                  <td>{{ employee.full_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                  <td>{{ employee.email }}</td>
                  <td>
                    <span class="btn {{ 'btn-warning' if employee.role == 'admin' else 'btn-info' }}" style="padding: 5px 10px; font-size: 0.8em;">
                      {{ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if employee.role == 'admin' else '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }}
                    </span>
                  </td>
                  <td>{{ employee.date_of_birth.strftime('%d.%m.%Y') if employee.date_of_birth else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                  <td>
                    {% if employee.store %}
                      <span class="btn btn-success" style="padding: 5px 10px; font-size: 0.8em;">
                        {{ employee.store.name }}
                      </span>
                    {% else %}
                      <span class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">
                        –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                      </span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="btn {{ 'btn-success' if employee.is_active else 'btn-danger' }}" style="padding: 5px 10px; font-size: 0.8em;">
                      {{ '–ê–∫—Ç–∏–≤–µ–Ω' if employee.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                    </span>
                  </td>
                  <td>
                    <!-- –§–æ—Ä–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ -->
                     <form method="post" action="/admin/employees/assign-store" style="display: inline-block; margin-right: 5px;" id="store-form-{{ employee.id }}">
                       <input type="hidden" name="employee_id" value="{{ employee.id }}">
                       <select name="store_id" onchange="submitStoreAssignment(this, '{{ employee.full_name or employee.email }}')" style="padding: 4px 6px; font-size: 0.85em; border: 1px solid #007bff; border-radius: 3px; background: white; cursor: pointer; min-width: 120px;">
                         <option value="">üè™ –°–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</option>
                         {% for store in stores %}
                         <option value="{{ store.id }}" {{ 'selected' if employee.store and employee.store.id == store.id else '' }}>
                           üè™ {{ store.name }}
                         </option>
                         {% endfor %}
                       </select>
                     </form>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
                    <form method="post" action="/admin/employees/toggle-status" style="display: inline-block;">
                      <input type="hidden" name="employee_id" value="{{ employee.id }}">
                      <button type="submit" class="btn {{ 'btn-danger' if employee.is_active else 'btn-success' }}" style="padding: 5px 10px; font-size: 0.8em;">
                        {{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if employee.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.</p>
          {% endif %}


        {% elif active_tab == 'scheduling_table' %}
          <h3>üìã –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <div class="form-section">
            <h4>–ú–µ—Å—è—á–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h4>

            <!-- Month/Year Selector -->
            <div class="month-selector" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
              <form method="get" action="/admin/scheduling-table" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: bold; color: #333;">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥:</label>
                <select name="month" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                  {% for month_option in months %}
                  <option value="{{ month_option.value }}" {{ 'selected' if month_option.value == selected_month else '' }}>
                    {{ month_option.name }}
                  </option>
                  {% endfor %}
                </select>
                <select name="year" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                  {% for year_option in years %}
                  <option value="{{ year_option.value }}" {{ 'selected' if year_option.value == selected_year else '' }}>
                    {{ year_option.name }}
                  </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
              </form>
              <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                üìÖ <strong>–¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä:</strong> {{ months[selected_month-1].name if selected_month else '–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü' }} {{ selected_year if selected_year else '—Ç–µ–∫—É—â–∏–π –≥–æ–¥' }}
              </div>
            </div>

            <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —è—á–µ–π–∫—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø —Å–º–µ–Ω—ã –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>

            <!-- Status indicator -->
            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
              <div style="display: flex; gap: 20px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #6c757d;">üìù</span>
                  <span>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏: <strong id="draft-count">0</strong></span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #28a745;">‚úì</span>
                  <span>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: <strong id="published-count">0</strong></span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #007bff;">üìä</span>
                  <span>–í—Å–µ–≥–æ: <strong id="total-count">0</strong></span>
                </div>
              </div>
            </div>

            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
              <p>üí° <strong>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</strong></p>
              <ul style="margin: 5px 0; padding-left: 20px;">
                <li>–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –∫–ª–µ—Ç–∫–µ = –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å</li>
                <li>–ó–∞–∂–∞—Ç—å –∏ —Ç—è–Ω—É—Ç—å –∫—É—Ä—Å–æ—Ä = –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã –Ω–∞ –¥—Ä—É–≥–∏–µ –∫–ª–µ—Ç–∫–∏</li>
                <li>Shift + –∑–∞–∂–∞—Ç—å –∏ —Ç—è–Ω—É—Ç—å = –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</li>
              </ul>
            </div>

            <!-- Legend for shift types -->
            <div class="shift-legend">
              <div class="legend-item">
                <div class="legend-color" style="background: #d4edda; border: 1px solid #28a745;"></div>
                <span>–†–∞–±–æ—á–∏–π –¥–µ–Ω—å</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #fff3cd; border: 1px solid #ffc107;"></div>
                <span>–í—ã—Ö–æ–¥–Ω–æ–π</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #f8d7da; border: 1px solid #dc3545;"></div>
                <span>–û—Ç–≥—É–ª</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #d1ecf1; border: 1px solid #17a2b8;"></div>
                <span>–û—Ç–ø—É—Å–∫</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #e2e3e5; border: 1px solid #6c757d;"></div>
                <span>–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</span>
              </div>
            </div>

            {% if employees and month_dates %}
            <div class="scheduling-container">
              <table class="scheduling-table">
                <thead>
                  <tr>
                    <th class="employee-column">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                    {% for work_date in month_dates %}
                    <th class="date-column">{{ work_date.strftime('%d.%m') }}<br><small>
                      {% if work_date.strftime('%a') == 'Mon' %}–ü–Ω
                      {% elif work_date.strftime('%a') == 'Tue' %}–í—Ç
                      {% elif work_date.strftime('%a') == 'Wed' %}–°—Ä
                      {% elif work_date.strftime('%a') == 'Thu' %}–ß—Ç
                      {% elif work_date.strftime('%a') == 'Fri' %}–ü—Ç
                      {% elif work_date.strftime('%a') == 'Sat' %}–°–±
                      {% elif work_date.strftime('%a') == 'Sun' %}–í—Å
                      {% endif %}
                    </small></th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for employee in employees %}
                  <tr>
                    <td class="employee-name">
                      {{ employee.full_name or employee.email }}
                      <br><small style="color: #666;">({{ "–ê–¥–º–∏–Ω" if employee.role == "admin" else "–°–æ—Ç—Ä—É–¥–Ω–∏–∫" }})</small>
                    </td>
                    {% for work_date in month_dates %}
                    {% set cell_key = employee.id ~ '_' ~ work_date %}
                    {% set existing_shift = schedule_dict[cell_key] %}
                    <td class="shift-cell {{ 'published' if existing_shift and existing_shift.published else 'draft' }}"
                        data-employee-id="{{ employee.id }}"
                        data-date="{{ work_date }}"
                        data-shift-type="{{ existing_shift.shift_type if existing_shift else '' }}"
                        onclick="handleCellClick(this)"
                        onmousedown="startSelection(this)"
                        onmouseover="extendSelection(this)">
                      <div class="shift-content">
                        {% if existing_shift %}
                        <span class="shift-type">
                          {% if existing_shift.shift_type == 'work' %}–†{% elif existing_shift.shift_type == 'off' %}–û{% elif existing_shift.shift_type == 'weekend' %}–í{% elif existing_shift.shift_type == 'vacation' %}–û—Ç–ø{% elif existing_shift.shift_type == 'sick' %}–ë{% endif %}
                        </span>
                        {% if existing_shift.start_time %}
                        <span class="shift-time">{{ existing_shift.start_time.strftime('%H:%M') }}</span>
                        {% endif %}
                        {% if not existing_shift.published %}
                        <span class="draft-indicator" title="–ß–µ—Ä–Ω–æ–≤–∏–∫ - –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ">üìù</span>
                        {% endif %}
                        {% else %}
                        <span class="shift-type">-</span>
                        {% endif %}
                      </div>
                      <div class="shift-dropdown-container">
                        {% for shift_type in shift_types %}
                        <button class="shift-dropdown"
                                data-value="{{ shift_type.value }}"
                                onclick="selectShiftType(event, this, '{{ employee.id }}', '{{ work_date }}')">
                          {{ shift_type.label }}
                        </button>
                        {% endfor %}
                        <button class="shift-dropdown"
                                data-value=""
                                onclick="selectShiftType(event, this, '{{ employee.id }}', '{{ work_date }}')">
                          –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                      </div>
                    </td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label for="default_store">–ú–∞–≥–∞–∑–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</label>
              <select id="default_store">
                <option value="">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –º–∞–≥–∞–∑–∏–Ω—É</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Publish Button -->
            <div class="form-group" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0; color: #155724;">üì¢ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h4>
              <p style="margin: 0 0 15px 0; color: #155724; font-size: 0.9em;">
                –ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–∏–º—ã–º –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.
              </p>
              <button type="button" class="btn btn-success" onclick="publishSchedule()" style="font-size: 1em; padding: 10px 20px;">
                üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
              </button>
              <div id="publish-status" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>
            {% else %}
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
            {% endif %}
          </div>

        {% elif active_tab == 'schedule' %}
          <h3>üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä–∞—Ñ–∏–∫–∞</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <!-- Month/Year Selector for Schedule View -->
          <div class="month-selector" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            <form method="get" action="/admin/schedule" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <label style="font-weight: bold; color: #333;">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥:</label>
              <select name="month" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                {% for month_option in months %}
                <option value="{{ month_option.value }}" {{ 'selected' if month_option.value == selected_month else '' }}>
                  {{ month_option.name }}
                </option>
                {% endfor %}
              </select>
              <select name="year" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                {% for year_option in years %}
                <option value="{{ year_option.value }}" {{ 'selected' if year_option.value == selected_year else '' }}>
                  {{ year_option.name }}
                </option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </form>
            <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
              üìÖ <strong>–¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä:</strong> {{ months[selected_month-1].name if selected_month else '–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü' }} {{ selected_year if selected_year else '—Ç–µ–∫—É—â–∏–π –≥–æ–¥' }}
            </div>
          </div>

          <!-- Info about published schedules only -->
          <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #004085;">üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞</h4>
            <p style="margin: 0; color: #004085; font-size: 0.9em;">
              –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ <strong>–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ</strong> —Å–º–µ–Ω—ã. –ò–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å".
            </p>
          </div>

          {% if employees and month_dates %}
          <div class="scheduling-container">
            <table class="scheduling-table">
              <thead>
                <tr>
                  <th class="employee-column">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                  {% for work_date in month_dates %}
                  <th class="date-column">{{ work_date.strftime('%d.%m') }}<br><small>
                    {% if work_date.strftime('%a') == 'Mon' %}–ü–Ω
                    {% elif work_date.strftime('%a') == 'Tue' %}–í—Ç
                    {% elif work_date.strftime('%a') == 'Wed' %}–°—Ä
                    {% elif work_date.strftime('%a') == 'Thu' %}–ß—Ç
                    {% elif work_date.strftime('%a') == 'Fri' %}–ü—Ç
                    {% elif work_date.strftime('%a') == 'Sat' %}–°–±
                    {% elif work_date.strftime('%a') == 'Sun' %}–í—Å
                    {% endif %}
                  </small></th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for employee in employees %}
                <tr>
                  <td class="employee-name">
                    {{ employee.full_name or employee.email }}
                    <br><small style="color: #666;">({{ "–ê–¥–º–∏–Ω" if employee.role == "admin" else "–°–æ—Ç—Ä—É–¥–Ω–∏–∫" }})</small>
                  </td>
                  {% for work_date in month_dates %}
                  {% set cell_key = employee.id ~ '_' ~ work_date %}
                  {% set existing_shift = schedule_dict[cell_key] %}
                  <td class="shift-cell"
                      data-employee-id="{{ employee.id }}"
                      data-date="{{ work_date }}"
                      data-shift-type="{{ existing_shift.shift_type if existing_shift else '' }}">
                    <div class="shift-content">
                      {% if existing_shift %}
                      <span class="shift-type">
                        {% if existing_shift.shift_type == 'work' %}–†{% elif existing_shift.shift_type == 'off' %}–û{% elif existing_shift.shift_type == 'weekend' %}–í{% elif existing_shift.shift_type == 'vacation' %}–û—Ç–ø{% elif existing_shift.shift_type == 'sick' %}–ë{% endif %}
                      </span>
                      {% if existing_shift.start_time %}
                      <span class="shift-time">{{ existing_shift.start_time.strftime('%H:%M') }}</span>
                      {% endif %}
                      {% else %}
                      <span class="shift-type">-</span>
                      {% endif %}
                    </div>
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Legend for shift types -->
          <div class="shift-legend">
            <div class="legend-item">
              <div class="legend-color" style="background: #d4edda; border: 1px solid #28a745;"></div>
              <span>–†–∞–±–æ—á–∏–π –¥–µ–Ω—å</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #fff3cd; border: 1px solid #ffc107;"></div>
              <span>–í—ã—Ö–æ–¥–Ω–æ–π</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f8d7da; border: 1px solid #dc3545;"></div>
              <span>–û—Ç–≥—É–ª</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #d1ecf1; border: 1px solid #17a2b8;"></div>
              <span>–û—Ç–ø—É—Å–∫</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #e2e3e5; border: 1px solid #6c757d;"></div>
              <span>–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</span>
            </div>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
            <h3 style="color: #6c757d; margin-bottom: 15px;">üì≠ –ù–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω</h3>
            <p style="color: #6c757d; margin: 0; font-size: 1.1em;">
              –°–º–µ–Ω—ã —Å—Ç–∞–Ω—É—Ç –≤–∏–¥–∏–º—ã–º–∏ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
            </p>
            <div style="margin-top: 20px;">
              <a href="/admin/scheduling-table" class="btn btn-primary" style="font-size: 1em; padding: 10px 20px;">
                üìÖ –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
              </a>
            </div>
          </div>
          {% endif %}

        {% elif active_tab == 'reports' %}
           <h3>üìä –û—Ç—á–µ—Ç—ã –ø–æ —Ä–∞–±–æ—á–µ–º—É –≤—Ä–µ–º–µ–Ω–∏</h3>
           {% if message %}<p>{{ message }}</p>{% endif %}

           <!-- Report Type Selection -->
           <div class="form-section">
             <h4>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞</h4>
             <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
               <a href="/admin/reports?report_type=month" class="btn {{ 'btn-primary' if report_type == 'month' else 'btn-outline-primary' }}">
                 üìÖ –û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü
               </a>
               <a href="/admin/reports?report_type=year" class="btn {{ 'btn-primary' if report_type == 'year' else 'btn-outline-primary' }}">
                 üìä –û—Ç—á–µ—Ç –∑–∞ –≥–æ–¥
               </a>
               <button type="button" class="btn {{ 'btn-primary' if report_type == 'custom' else 'btn-outline-primary' }}" onclick="toggleCustomDatePicker()">
                 üìÜ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
               </button>
             </div>

             <!-- Month/Year Selector for Monthly Reports -->
             {% if report_type == 'month' %}
             <div class="month-selector" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
               <h5 style="margin: 0 0 15px 0; color: #333;">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥ –¥–ª—è –æ—Ç—á–µ—Ç–∞</h5>
               <form method="get" action="/admin/reports" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                 <input type="hidden" name="report_type" value="month">
                 <div>
                   <label for="month" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">–ú–µ—Å—è—Ü:</label>
                   <select name="month" id="month" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; min-width: 140px;">
                     {% for month_option in months %}
                     <option value="{{ month_option.value }}" {{ 'selected' if month_option.value == selected_month else '' }}>
                       {{ month_option.name }}
                     </option>
                     {% endfor %}
                   </select>
                 </div>
                 <div>
                   <label for="year" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">–ì–æ–¥:</label>
                   <select name="year" id="year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; min-width: 100px;">
                     {% for year_option in years %}
                     <option value="{{ year_option.value }}" {{ 'selected' if year_option.value == selected_year else '' }}>
                       {{ year_option.name }}
                     </option>
                     {% endfor %}
                   </select>
                 </div>
                 <div style="align-self: flex-end;">
                   <button type="submit" class="btn btn-success" style="padding: 8px 20px; font-size: 0.9em;">
                     üìä –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á–µ—Ç
                   </button>
                 </div>
               </form>
               <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                 üìÖ <strong>–¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä:</strong> {{ months[selected_month-1].name if selected_month else '–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü' }} {{ selected_year if selected_year else '—Ç–µ–∫—É—â–∏–π –≥–æ–¥' }}
               </div>
             </div>
             {% endif %}

             <!-- Custom Date Picker (hidden by default) -->
             <div id="custom-date-picker" class="custom-date-picker {{ 'visible' if report_type == 'custom' else 'hidden' }}">
               <h5>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã</h5>
               <form method="get" action="/admin/reports" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                 <input type="hidden" name="report_type" value="custom">
                 <div>
                   <label for="start_date" style="display: block; margin-bottom: 5px; font-weight: bold;">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                   <input type="date" id="start_date" name="start_date" value="{{ start_date }}" required class="form-group" style="width: auto;">
                 </div>
                 <div>
                   <label for="end_date" style="display: block; margin-bottom: 5px; font-weight: bold;">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                   <input type="date" id="end_date" name="end_date" value="{{ end_date }}" required class="form-group" style="width: auto;">
                 </div>
                 <div style="align-self: flex-end;">
                   <button type="submit" class="btn btn-success">üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                 </div>
               </form>
             </div>

             <!-- Report Summary -->
             {% if report_data %}
             <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
               <h5 style="margin: 0 0 10px 0; color: #155724;">üìà –°–≤–æ–¥–∫–∞ –ø–æ –æ—Ç—á–µ—Ç—É</h5>
               <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                 <div><strong>–ü–µ—Ä–∏–æ–¥:</strong> {{ start_date }} - {{ end_date }}</div>
                 <div><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</strong> {{ total_employees }}</div>
                 <div><strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong> {{ total_hours_all }} —á</div>
                 <div><strong>–†–∞–±–æ—á–∏—Ö —Å–º–µ–Ω:</strong> {{ total_shifts_all }}</div>
               </div>
             </div>
             {% endif %}
           </div>

           <!-- Report Table -->
           {% if report_data %}
           <div class="form-section">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
               <h4 style="margin: 0;">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h4>
               <a href="/admin/reports/export?report_type={{ report_type }}&start_date={{ start_date }}&end_date={{ end_date }}{% if report_type == 'month' %}&month={{ selected_month }}&year={{ selected_year }}{% endif %}" class="btn btn-success">
                 üì• –°–∫–∞—á–∞—Ç—å Excel
               </a>
             </div>

             <div style="overflow-x: auto;">
               <table class="table">
                 <thead>
                   <tr>
                     <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                     <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                     <th>–†–∞–±–æ—á–∏–µ —á–∞—Å—ã</th>
                     <th>–†–∞–±–æ—á–∏–µ —Å–º–µ–Ω—ã</th>
                     <th>–†–∞–±–æ—á–∏–µ –¥–Ω–∏<br><small>(–ø–æ –≥—Ä–∞—Ñ–∏–∫—É)</small></th>
                     <th>–û—Ç–≥—É–ª—ã</th>
                     <th>–û—Ç–ø—É—Å–∫–∞</th>
                     <th>–ë–æ–ª—å–Ω–∏—á–Ω—ã–µ</th>
                     <th>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è<br><small>–∑–∞ —Å–º–µ–Ω—É</small></th>
                   </tr>
                 </thead>
                 <tbody>
                   {% for data in report_data %}
                   <tr>
                     <td>
                       <strong>{{ data.employee.full_name or data.employee.email }}</strong>
                       <br><small style="color: #666;">{{ data.employee.email }}</small>
                     </td>
                     <td>
                       {% if '@bot.local' in data.employee.email %}
                       <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">ü§ñ –ë–æ—Ç</span>
                       {% else %}
                       <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">üåê –í–µ–±</span>
                       {% endif %}
                     </td>
                     <td>
                       <span style="font-weight: bold; color: #007bff;">{{ data.total_hours }} —á</span>
                     </td>
                     <td>
                       <span style="font-weight: bold; color: #28a745;">{{ data.working_shifts }}</span>
                     </td>
                     <td>
                       <span style="color: #17a2b8;">{{ data.work_days }}</span>
                     </td>
                     <td>
                       <span style="color: #ffc107;">{{ data.days_off }}</span>
                     </td>
                     <td>
                       <span style="color: #6f42c1;">{{ data.vacations }}</span>
                     </td>
                     <td>
                       <span style="color: #dc3545;">{{ data.sick_days }}</span>
                     </td>
                     <td>
                       {% if data.working_shifts > 0 %}
                       <span style="color: #20c997;">{{ "%.1f"|format(data.total_hours / data.working_shifts) }} —á</span>
                       {% else %}
                       <span style="color: #6c757d;">-</span>
                       {% endif %}
                     </td>
                   </tr>
                   {% endfor %}
                 </tbody>
                 <tfoot>
                   <tr style="background: #f8f9fa; font-weight: bold;">
                     <td><strong>–ò–¢–û–ì–û</strong></td>
                     <td style="text-align: center; color: #6c757d;">-</td>
                     <td><strong style="color: #007bff;">{{ total_hours_all }} —á</strong></td>
                     <td><strong style="color: #28a745;">{{ total_shifts_all }}</strong></td>
                     <td colspan="4" style="text-align: center; color: #6c757d;">-</td>
                     <td>
                       {% if total_shifts_all > 0 %}
                       <strong style="color: #20c997;">{{ "%.1f"|format(total_hours_all / total_shifts_all) }} —á</strong>
                       {% else %}
                       <strong style="color: #6c757d;">-</strong>
                       {% endif %}
                     </td>
                   </tr>
                 </tfoot>
               </table>
             </div>
           </div>
           {% else %}
           <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
             <h4 style="color: #6c757d; margin-bottom: 15px;">üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
             <p style="color: #6c757d; margin: 0;">
               –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
             </p>
           </div>
           {% endif %}

        {% elif active_tab == 'stores' %}
          <h3>üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞–º–∏</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          
          <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ -->
          <div class="form-section">
            <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω</h4>
            <form method="post" action="/admin/stores/create">
              <div class="form-group">
                <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:</label>
                <input type="text" id="name" name="name" required>
              </div>
              
              <div class="form-group">
                <label for="address">–ê–¥—Ä–µ—Å:</label>
                <input type="text" id="address" name="address">
              </div>
              
              <div class="form-group">
                <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="text" id="phone" name="phone">
              </div>
              
              <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
            </form>
          </div>
          
          <!-- –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ -->
          {% if stores %}
          <div class="form-section">
            <h4>–°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ê–¥—Ä–µ—Å</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                </tr>
              </thead>
              <tbody>
                {% for store in stores %}
                <tr>
                  <td>{{ store.name }}</td>
                  <td>{{ store.address or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                  <td>{{ store.phone or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p>–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤.</p>
          {% endif %}

       {% elif active_tab == 'attendance' %}
          <h3>‚è∞ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <!-- Success/Error Messages -->
          {% if request.query_params.get('success') == 'created' %}
          <div class="alert alert-success">
            ‚úÖ –ó–∞–ø–∏—Å—å –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
          </div>
          {% elif request.query_params.get('success') == 'updated' %}
          <div class="alert alert-success">
            ‚úÖ –ó–∞–ø–∏—Å—å –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!
          </div>
          {% elif request.query_params.get('success') == 'deleted' %}
          <div class="alert alert-success">
            ‚úÖ –ó–∞–ø–∏—Å—å –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!
          </div>
          {% elif request.query_params.get('error') == 'no_start_time' %}
          <div class="alert alert-danger">
            ‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞!
          </div>
          {% elif request.query_params.get('error') == 'server_error' %}
          <div class="alert alert-danger">
            ‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!
          </div>
          {% endif %}

          <!-- Employee and Date Selection -->
          <div class="form-section">
            <h4>–í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –¥–∞—Ç—ã</h4>
            <form method="get" action="/admin/attendance" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
              <div>
                <label for="employee_id" style="display: block; margin-bottom: 5px; font-weight: bold;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
                <select name="employee_id" id="employee_id" class="form-group" style="width: 250px;" required>
                  <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
                  {% for employee in employees %}
                  <option value="{{ employee.id }}" {{ 'selected' if selected_employee_id and selected_employee_id == employee.id else '' }}>
                    {{ employee.full_name or employee.email }} ({{ employee.email }})
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="selected_date" style="display: block; margin-bottom: 5px; font-weight: bold;">–î–∞—Ç–∞:</label>
                <input type="date" name="selected_date" id="selected_date" value="{{ selected_date or '' }}" class="form-group" required>
              </div>
              <div>
                <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å</button>
              </div>
            </form>
          </div>

          <!-- Attendance Editing Form -->
          {% if selected_employee_id and selected_date %}
          <div class="form-section">
            <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</h4>

            {% if attendance_record %}
            <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <h5 style="margin: 0 0 10px 0; color: #155724;">üìù –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å</h5>
              <p style="margin: 0; color: #155724;">
                <strong>–ü—Ä–∏—Ö–æ–¥:</strong> {{ attendance_record.started_at.strftime('%H:%M') if attendance_record.started_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}<br>
                <strong>–£—Ö–æ–¥:</strong> {{ attendance_record.ended_at.strftime('%H:%M') if attendance_record.ended_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}<br>
                <strong>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</strong> {{ "%.2f"|format(attendance_record.hours) if attendance_record.hours else '–ù–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ' }}
              </p>
            </div>
            {% else %}
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <h5 style="margin: 0 0 10px 0; color: #856404;">üìù –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h5>
              <p style="margin: 0; color: #856404;">
                –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –¥–∞—Ç—ã –∑–∞–ø–∏—Å–∏ –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å.
              </p>
            </div>
            {% endif %}

            <form method="post" action="/admin/attendance/save">
              <input type="hidden" name="employee_id" value="{{ selected_employee_id }}">
              <input type="hidden" name="work_date" value="{{ selected_date }}">

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                  <label for="start_time">–í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞:</label>
                  <input type="time" id="start_time" name="start_time"
                         value="{{ attendance_record.started_at.strftime('%H:%M') if attendance_record and attendance_record.started_at else '' }}"
                         class="form-group">
                </div>
                <div class="form-group">
                  <label for="end_time">–í—Ä–µ–º—è —É—Ö–æ–¥–∞:</label>
                  <input type="time" id="end_time" name="end_time"
                         value="{{ attendance_record.ended_at.strftime('%H:%M') if attendance_record and attendance_record.ended_at else '' }}"
                         class="form-group">
                </div>
              </div>

              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="submit" class="btn btn-success">
                  üíæ {{ '–û–±–Ω–æ–≤–∏—Ç—å' if attendance_record else '–°–æ–∑–¥–∞—Ç—å' }} –∑–∞–ø–∏—Å—å
                </button>

                {% if attendance_record %}
                <a href="/admin/attendance/delete/{{ attendance_record.id }}" class="btn btn-danger"
                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏?')">
                  üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
                </a>
                {% endif %}

                <a href="/admin/attendance" class="btn btn-secondary">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</a>
              </div>
            </form>
          </div>
          {% endif %}

          <!-- Recent Attendance Records -->
          {% if recent_attendances %}
          <div class="form-section">
            <h4>üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏</h4>
            <div style="overflow-x: auto;">
              <table class="table">
                <thead>
                  <tr>
                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ü—Ä–∏—Ö–æ–¥</th>
                    <th>–£—Ö–æ–¥</th>
                    <th>–ß–∞—Å—ã</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody>
                  {% for attendance in recent_attendances %}
                  <tr>
                    <td>
                      <strong>{{ attendance.user.full_name or attendance.user.email }}</strong>
                      <br><small style="color: #666;">{{ attendance.user.email }}</small>
                    </td>
                    <td>{{ attendance.work_date.strftime('%d.%m.%Y') }}</td>
                    <td>{{ attendance.started_at.strftime('%H:%M') if attendance.started_at else '-' }}</td>
                    <td>{{ attendance.ended_at.strftime('%H:%M') if attendance.ended_at else '-' }}</td>
                    <td>{{ "%.2f"|format(attendance.hours) if attendance.hours else '-' }}</td>
                    <td>
                      <a href="/admin/attendance?employee_id={{ attendance.user_id }}&selected_date={{ attendance.work_date }}"
                         class="btn btn-sm btn-primary" style="padding: 3px 8px; font-size: 0.8em;">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

        {% elif active_tab == 'allowed_ips' %}
          <h3>üîí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º–∏ IP –∞–¥—Ä–µ—Å–∞–º–∏</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}

          <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö -->
          {% if request.query_params.get('success') == 'created' %}
          <div class="alert alert-success">
            ‚úÖ IP –∞–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!
          </div>
          {% elif request.query_params.get('success') == 'deleted' %}
          <div class="alert alert-success">
            ‚úÖ IP –∞–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!
          </div>
          {% elif request.query_params.get('success') == 'status_changed' %}
          <div class="alert alert-success">
            ‚úÖ –°—Ç–∞—Ç—É—Å IP –∞–¥—Ä–µ—Å–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!
          </div>
          {% elif request.query_params.get('error') == 'ip_exists' %}
          <div class="alert alert-danger">
            ‚ùå –≠—Ç–æ—Ç IP –∞–¥—Ä–µ—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
          </div>
          {% elif request.query_params.get('error') == 'ip_exists' %}
          <div class="alert alert-danger">
            ‚ùå –≠—Ç–æ—Ç IP –∞–¥—Ä–µ—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
          </div>
          {% elif request.query_params.get('error') == 'server_error' %}
          <div class="alert alert-danger">
            ‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!
          </div>
          {% elif request.query_params.get('error') == 'delete_error' %}
          <div class="alert alert-danger">
            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ IP –∞–¥—Ä–µ—Å–∞!
          </div>
          {% elif request.query_params.get('error') == 'status_error' %}
          <div class="alert alert-danger">
            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ IP –∞–¥—Ä–µ—Å–∞!
          </div>
          {% endif %}

          <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ IP -->
          <div class="form-section">
            <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π IP –∞–¥—Ä–µ—Å</h4>
            <form method="post" action="/admin/allowed-ips/create">
              <div class="form-group">
                <label for="ip_address">IP –∞–¥—Ä–µ—Å:</label>
                <input type="text" id="ip_address" name="ip_address" required
                       placeholder="192.168.1.1 –∏–ª–∏ 2001:db8::1" pattern="^(\d{1,3}\.){3}\d{1,3}$|^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$"
                       title="–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IPv4 –∏–ª–∏ IPv6 –∞–¥—Ä–µ—Å">
              </div>

              <div class="form-group">
                <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="description" name="description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ñ–∏—Å–Ω–∞—è —Å–µ—Ç—å">
              </div>

              <button type="submit" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å IP –∞–¥—Ä–µ—Å</button>
            </form>
          </div>

          <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP -->
          {% if allowed_ips %}
          <div class="form-section">
            <h4>–°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>IP –∞–¥—Ä–µ—Å</th>
                  <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                  <th>–°–æ–∑–¥–∞–ª</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                {% for ip in allowed_ips %}
                <tr>
                  <td>
                    <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace;">
                      {{ ip.ip_address }}
                    </code>
                  </td>
                  <td>{{ ip.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</td>
                  <td>
                    <span class="btn {{ 'btn-success' if ip.is_active else 'btn-danger' }}" style="padding: 3px 8px; font-size: 0.8em;">
                      {{ '–ê–∫—Ç–∏–≤–µ–Ω' if ip.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                    </span>
                  </td>
                  <td>{{ ip.created_at.strftime('%d.%m.%Y %H:%M') if ip.created_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</td>
                  <td>{{ ip.creator.full_name if ip.creator else '–°–∏—Å—Ç–µ–º–∞' }}</td>
                  <td>
                    <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
                    <form method="post" action="/admin/allowed-ips/toggle/{{ ip.id }}" style="display: inline-block; margin-right: 5px;">
                      <button type="submit" class="btn {{ 'btn-warning' if ip.is_active else 'btn-success' }}"
                              style="padding: 3px 8px; font-size: 0.8em;">
                        {{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if ip.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
                      </button>
                    </form>

                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                    <form method="post" action="/admin/allowed-ips/delete/{{ ip.id }}" style="display: inline-block;">
                      <button type="submit" class="btn btn-danger" style="padding: 3px 8px; font-size: 0.8em;">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #6c757d; margin-bottom: 15px;">üì≠ –ù–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤</h4>
            <p style="color: #6c757d; margin: 0;">
              –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π IP –∞–¥—Ä–µ—Å —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã –≤—ã—à–µ
            </p>
          </div>
          {% endif %}

        {% else %}
          <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å!</h3>
          {% if message %}<p>{{ message }}</p>{% endif %}
          <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤—ã—à–µ.</p>
        {% endif %}
      </div>
    </div>

    <script>
      let isSelecting = false;
      let isPainting = false;
      let isMouseDown = false;
      let startCell = null;
      let selectedCells = [];
      let currentShiftType = '';
      let paintShiftType = '';

      let clickCount = 0;
      let clickTimer = null;

      function handleCellClick(cell) {
        if (isSelecting) return;

        clickCount++;

        if (clickCount === 1) {
          // Single click - show menu
          clickTimer = setTimeout(() => {
            clickCount = 0;
            // Menu will be shown via CSS hover
          }, 300);
        } else if (clickCount === 2) {
          // Double click - set to weekend
          clearTimeout(clickTimer);
          clickCount = 0;
          quickSetWeekend(cell);
        }
      }

      async function quickSetWeekend(cell) {
        const employeeId = cell.dataset.employeeId;
        const workDate = cell.dataset.date;
        const defaultStore = document.getElementById('default_store')?.value || '';

        // Visual feedback
        cell.style.opacity = '0.6';

        try {
          const formData = new FormData();
          formData.append('employee_id', employeeId);
          formData.append('work_date', workDate);
          formData.append('shift_type', 'weekend');
          if (defaultStore) {
            formData.append('store_id', defaultStore);
          }

          const response = await fetch('/admin/scheduling-table/toggle', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // Update cell appearance immediately
            cell.dataset.shiftType = 'weekend';
            updateCellContent(cell, 'weekend');

            // Reload page after short delay
            setTimeout(() => {
              window.location.reload();
            }, 200);
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ:', error);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
        } finally {
          cell.style.opacity = '1';
        }
      }

      function updateCellContent(cell, shiftType) {
        const content = cell.querySelector('.shift-content');
        if (content) {
          const typeSpan = content.querySelector('.shift-type');
          if (typeSpan) {
            if (shiftType === 'work') typeSpan.textContent = '–†';
            else if (shiftType === 'off') typeSpan.textContent = '–û';
            else if (shiftType === 'weekend') typeSpan.textContent = '–í';
            else if (shiftType === 'vacation') typeSpan.textContent = '–û—Ç–ø';
            else if (shiftType === 'sick') typeSpan.textContent = '–ë';
            else typeSpan.textContent = '-';
          }
        }
      }

      function startSelection(cell) {
        isMouseDown = true;

        if (event.shiftKey) {
          // –ù–∞—á–∏–Ω–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
          isSelecting = true;
          startCell = cell;
          selectedCells = [cell];
          cell.classList.add('selected');
          currentShiftType = cell.dataset.shiftType || '';

          // –°–æ–∑–¥–∞–µ–º overlay –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—ã–±–æ—Ä–∞
          createSelectionOverlay();

          event.preventDefault();
        } else {
          // –ù–∞—á–∏–Ω–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã)
          isPainting = true;
          paintShiftType = cell.dataset.shiftType || 'work';

          // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
          cell.classList.add('painting');

          event.preventDefault();
        }
      }

      function extendSelection(cell) {
        if (!isMouseDown) return; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ –æ—Ç–ø—É—â–µ–Ω–∞

        if (isSelecting && startCell) {
          // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —Å Shift
          // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
          selectedCells.forEach(c => c.classList.remove('selected'));
          selectedCells = [];

          // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞—á–∞–ª—å–Ω–æ–π –∏ —Ç–µ–∫—É—â–µ–π —è—á–µ–π–∫–∏
          const startRect = startCell.getBoundingClientRect();
          const currentRect = cell.getBoundingClientRect();
          const table = startCell.closest('table');
          const allCells = Array.from(table.querySelectorAll('.shift-cell'));

          // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —è—á–µ–π–∫–∏ –≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–µ –≤—ã–±–æ—Ä–∞
          const minLeft = Math.min(startRect.left, currentRect.left);
          const maxRight = Math.max(startRect.right, currentRect.right);
          const minTop = Math.min(startRect.top, currentRect.top);
          const maxBottom = Math.max(startRect.bottom, currentRect.bottom);

          allCells.forEach(cell => {
            const cellRect = cell.getBoundingClientRect();
            if (cellRect.left >= minLeft && cellRect.right <= maxRight &&
                cellRect.top >= minTop && cellRect.bottom <= maxBottom) {
              cell.classList.add('selected');
              selectedCells.push(cell);
            }
          });

          // –û–±–Ω–æ–≤–ª—è–µ–º overlay
          updateSelectionOverlay(minLeft, minTop, maxRight - minLeft, maxBottom - minTop);
        } else if (isPainting && cell !== startCell) {
          // –†–∏—Å–æ–≤–∞–Ω–∏–µ (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã)
          paintCell(cell);
        }
      }

      async function paintCell(cell) {
        const currentType = cell.dataset.shiftType;
        if (currentType === paintShiftType) return; // –£–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø

        const employeeId = cell.dataset.employeeId;
        const workDate = cell.dataset.date;
        const defaultStore = document.getElementById('default_store')?.value || '';

        try {
          const formData = new FormData();
          formData.append('employee_id', employeeId);
          formData.append('work_date', workDate);
          formData.append('shift_type', paintShiftType);
          if (defaultStore) {
            formData.append('store_id', defaultStore);
          }

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
          if (paintShiftType === 'work') {
            formData.append('start_time', '09:00');
            formData.append('end_time', '17:00');
          }

          const response = await fetch('/admin/scheduling-table/toggle', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ
            cell.dataset.shiftType = paintShiftType;
            updateCellContent(cell, paintShiftType);
            cell.classList.add('painted');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ —Å–º–µ–Ω—ã:', error);
        }
      }

      function createSelectionOverlay() {
        const overlay = document.createElement('div');
        overlay.className = 'selection-overlay';
        overlay.id = 'selection-overlay';
        document.body.appendChild(overlay);
      }

      function updateSelectionOverlay(left, top, width, height) {
        const overlay = document.getElementById('selection-overlay');
        if (overlay) {
          overlay.style.left = left + 'px';
          overlay.style.top = top + 'px';
          overlay.style.width = width + 'px';
          overlay.style.height = height + 'px';
        }
      }

      function selectShiftType(event, button, employeeId, workDate) {
        event.stopPropagation();
        const shiftType = button.dataset.value;
        const defaultStore = document.getElementById('default_store')?.value || '';

        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä), –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º
        if (selectedCells.length > 1) {
          applyShiftToMultipleCells(shiftType, defaultStore);
        } else {
          // –û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä
          applyShiftToCell(employeeId, workDate, shiftType, defaultStore);
        }

        // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä
        clearSelection();
      }

      async function applyShiftToCell(employeeId, workDate, shiftType, storeId) {
        try {
          const formData = new FormData();
          formData.append('employee_id', employeeId);
          formData.append('work_date', workDate);
          formData.append('shift_type', shiftType);
          if (storeId) {
            formData.append('store_id', storeId);
          }

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
          if (shiftType === 'work') {
            formData.append('start_time', '09:00');
            formData.append('end_time', '17:00');
          }

          const response = await fetch('/admin/scheduling-table/toggle', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            setTimeout(() => {
              window.location.reload();
            }, 200);
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã:', error);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
        }
      }

      async function applyShiftToMultipleCells(shiftType, storeId) {
        const promises = selectedCells.map(cell => {
          const employeeId = cell.dataset.employeeId;
          const workDate = cell.dataset.date;
          return applyShiftToCell(employeeId, workDate, shiftType, storeId);
        });

        try {
          await Promise.all(promises);
          setTimeout(() => {
            window.location.reload();
          }, 200);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–º–µ–Ω:', error);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
        }
      }

      function clearSelection() {
        isSelecting = false;
        isPainting = false;
        isMouseDown = false;
        startCell = null;

        // –û—á–∏—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
        selectedCells.forEach(cell => {
          cell.classList.remove('selected');
          cell.classList.remove('painting');
          cell.classList.remove('painted');
        });
        selectedCells = [];

        // –£–¥–∞–ª—è–µ–º overlay
        const overlay = document.getElementById('selection-overlay');
        if (overlay) {
          overlay.remove();
        }
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
      document.addEventListener('mousedown', function(e) {
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
        if (e.button === 0) { // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞
          isMouseDown = true;
        }
      });

      document.addEventListener('mouseup', function(e) {
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
        if (e.button === 0) { // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞
          isMouseDown = false;
          if (isSelecting || isPainting) {
            clearSelection();
          }
        }
      });

      // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã
      document.addEventListener('mouseup', function() {
        if (isSelecting) {
          clearSelection();
        }
      });

      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –≤—ã–±–æ—Ä–µ
      document.addEventListener('selectstart', function(e) {
        if (isSelecting) {
          e.preventDefault();
        }
      });

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      async function publishSchedule() {
        const publishButton = document.querySelector('button[onclick="publishSchedule()"]');
        const statusDiv = document.getElementById('publish-status');

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
        const urlParams = new URLSearchParams(window.location.search);
        const month = urlParams.get('month') || new Date().getMonth() + 1;
        const year = urlParams.get('year') || new Date().getFullYear();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        publishButton.disabled = true;
        publishButton.textContent = '‚è≥ –ü—É–±–ª–∏–∫—É–µ–º...';
        statusDiv.innerHTML = '<span style="color: #007bff;">–ü—É–±–ª–∏–∫—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ...</span>';

        try {
          const formData = new FormData();
          formData.append('month', month);
          formData.append('year', year);

          const response = await fetch('/admin/scheduling-table/publish', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ ${result.message}</span>`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! ${result.published_count} —Å–º–µ–Ω —Å—Ç–∞–ª–∏ –≤–∏–¥–∏–º—ã–º–∏ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.`, 'success');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞: ${result.error}</span>`;
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è', 'error');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
          statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</span>';
          showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è', 'error');
        } finally {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          publishButton.disabled = false;
          publishButton.textContent = 'üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ';
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
          color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
          border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
          padding: 15px 20px;
          border-radius: 5px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          z-index: 10000;
          font-weight: 500;
          max-width: 400px;
          animation: slideIn 0.3s ease-out;
        `;

        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
          </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 5000);

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
        setTimeout(() => {
          const slideOutStyle = document.createElement('style');
          slideOutStyle.textContent = `
            @keyframes slideOut {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(100%); opacity: 0; }
            }
          `;
          document.head.appendChild(slideOutStyle);
        }, 4500);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
      function confirmAction(message) {
        return confirm(message);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
      function submitStoreAssignment(selectElement, employeeName) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const storeName = selectedOption.text;
        const storeId = selectElement.value;

        let message = '';
        if (storeId === '') {
          message = `–°–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${employeeName}"?`;
        } else {
          message = `–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω "${storeName}" —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É "${employeeName}"?`;
        }

        if (confirm(message)) {
          // –ù–∞—Ö–æ–¥–∏–º —Ñ–æ—Ä–º—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë
          const form = selectElement.closest('form');
          if (form) {
            form.submit();
          }
        } else {
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          const previousValue = selectElement.getAttribute('data-previous-value') || '';
          selectElement.value = previousValue;
        }
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è select —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      document.addEventListener('DOMContentLoaded', function() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –º–∞–≥–∞–∑–∏–Ω–æ–≤
        const storeSelects = document.querySelectorAll('select[name="store_id"]');
        storeSelects.forEach(select => {
          select.addEventListener('focus', function() {
            this.setAttribute('data-previous-value', this.value);
          });
        });
      });

      // Function to count and display schedule status
      function updateScheduleCounts() {
        const draftCount = document.querySelectorAll('.shift-cell.draft').length;
        const publishedCount = document.querySelectorAll('.shift-cell.published').length;
        const totalCount = draftCount + publishedCount;

        document.getElementById('draft-count').textContent = draftCount;
        document.getElementById('published-count').textContent = publishedCount;
        document.getElementById('total-count').textContent = totalCount;
      }

      // Function to toggle custom date picker
      function toggleCustomDatePicker() {
        const picker = document.getElementById('custom-date-picker');
        if (picker) {
          if (picker.classList.contains('hidden')) {
            picker.classList.remove('hidden');
            picker.classList.add('visible');
          } else {
            picker.classList.remove('visible');
            picker.classList.add('hidden');
          }
        }
      }

      // Ensure select dropdowns work properly
      document.addEventListener('DOMContentLoaded', function() {
        // Update counts on page load
        updateScheduleCounts();

        // Add mouse leave handler for scheduling table to stop painting when mouse leaves
        const schedulingTable = document.querySelector('.scheduling-table');
        if (schedulingTable) {
          schedulingTable.addEventListener('mouseleave', function() {
            if (isPainting && !isMouseDown) {
              clearSelection();
            }
          });
        }

        // Fix for select dropdowns
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
          select.addEventListener('mousedown', function(e) {
            // Prevent default behavior that might interfere
            e.stopPropagation();
          });

          select.addEventListener('change', function() {
            console.log('Select changed:', this.name, this.value);
          });
        });

        // Debug form submission
        const monthForm = document.querySelector('form[action="/admin/scheduling-table"]');
        if (monthForm) {
          monthForm.addEventListener('submit', function(e) {
            console.log('Form submitted with month:', this.month.value, 'year:', this.year.value);
            // Add visual feedback
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
              submitBtn.disabled = true;
            }
          });
        }

        // Test select functionality
        const testSelect = document.querySelector('select[name="month"]');
        if (testSelect) {
          testSelect.addEventListener('change', function() {
            console.log('Month select changed to:', this.value);
          });
        }
      });
    </script>
  </body>
</html>
