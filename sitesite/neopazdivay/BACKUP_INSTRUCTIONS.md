# Инструкция по настройке автоматического бэкапа базы данных

## Обзор
Система автоматически создает резервные копии базы данных SQLite `time_tracker.db` раз в неделю.
Резервные копии сохраняются в папку `backups/` с временными метками.

## Файлы
- `backup_db.py` - основной скрипт для создания резервной копии
- `run_backup.bat` - бат-файл для запуска через планировщик задач
- `backups/` - папка для хранения резервных копий

## Настройка планировщика задач Windows

### Шаг 1: Открыть планировщик задач
1. Нажмите `Win + R`, введите `taskschd.msc` и нажмите Enter
2. Или найдите "Планировщик задач" в поиске Windows

### Шаг 2: Создать новую задачу
1. В правой панели выберите "Создать задачу..."
2. На вкладке "Общие":
   - Имя: `Database Backup Weekly`
   - Выберите "Выполнять с наивысшими правами"
   - Настройте для: Windows 10 (или вашей версии)

### Шаг 3: Настроить триггер (расписание)
1. Перейдите на вкладку "Триггеры"
2. Нажмите "Создать..."
3. Настройки:
   - Начать задачу: "По расписанию"
   - Еженедельно
   - Запускать каждые: 1 неделю
   - Выберите день недели (например, воскресенье)
   - Время запуска: выберите удобное время (например, 02:00)
   - Включено: ✓

### Шаг 4: Настроить действие (что выполнять)
1. Перейдите на вкладку "Действия"
2. Нажмите "Создать..."
3. Настройки:
   - Действие: "Запуск программы"
   - Программа/сценарий: `C:\Users\User\sitesite\neopazdivay\run_backup.bat`
   - **Примечание:** Замените путь на полный путь к вашему файлу `run_backup.bat`

### Шаг 5: Настроить условия (опционально)
1. Перейдите на вкладку "Условия"
2. Рекомендуемые настройки:
   - Запускать только при питании от сети: ✓
   - Пробуждать компьютер для выполнения задачи: ✓

### Шаг 6: Настроить параметры (опционально)
1. Перейдите на вкладку "Параметры"
2. Если задача не выполнена:
   - Повторять попытку: ✓
   - Повторять каждые: 1 час
   - В течение: 1 дня

### Шаг 7: Сохранить задачу
1. Нажмите "OK"
2. При необходимости введите пароль администратора

## Проверка работы

### Ручной запуск
```cmd
cd C:\Users\User\sitesite\neopazdivay
run_backup.bat
```

### Проверка логов
- Планировщик задач ведет логи выполнения
- В папке `backups/` должны появляться новые файлы с именами типа `time_tracker_backup_YYYYMMDD_HHMMSS.db`

### Просмотр истории выполнения
1. В планировщике задач найдите вашу задачу
2. Правой кнопкой мыши → "Свойства"
3. Вкладка "История" - показывает все запуски и их статус

## Управление резервными копиями

### Автоматическая очистка
Скрипт автоматически удаляет старые резервные копии, оставляя только последние 10 файлов.

### Ручная очистка
```cmd
# Просмотр файлов
dir backups\

# Удаление конкретного файла
del backups\time_tracker_backup_20230101_120000.db
```

## Восстановление из резервной копии

### Остановка сервера
Сначала остановите FastAPI сервер, чтобы база данных не была заблокирована.

### Замена файла базы данных
```cmd
# Переименовать текущую базу данных
ren time_tracker.db time_tracker_old.db

# Скопировать резервную копию
copy backups\time_tracker_backup_20230101_120000.db time_tracker.db
```

### Проверка
Запустите сервер и проверьте работу приложения.

## Устранение неполадок

### Задача не запускается
1. Проверьте путь к `run_backup.bat` в настройках задачи
2. Убедитесь, что Python установлен и доступен в PATH
3. Проверьте права доступа к папке проекта

### Python не найден
1. Установите Python с опцией "Add to PATH"
2. Или укажите полный путь к python.exe в `run_backup.bat`:
   ```
   "C:\Python39\python.exe" backup_db.py
   ```

### Ошибки доступа к файлам
1. Запустите планировщик задач от имени администратора
2. Проверьте права доступа к папке `neopazdivay`

## Мониторинг

### Проверка статуса
- Откройте планировщик задач
- Найдите задачу "Database Backup Weekly"
- Проверьте "Последний результат запуска"

### Уведомления
Для получения уведомлений о неудачных запусках:
1. В свойствах задачи → вкладка "Параметры"
2. Отправлять письмо: настройте email уведомления (требует SMTP сервера)